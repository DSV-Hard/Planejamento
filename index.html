<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PLANEJAMENTO</title>
	<link rel="icon" type="image/png" href="https://raw.githubusercontent.com/DSV-Hard/Planejamento/main/favicon.png">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    h1 { font-size: 2em; text-align: center; margin-bottom: 30px; }
    #main-frame {
        background-color: #ffffff; /* Fundo branco para o quadro */
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1); /* Sombra sutil para destacar o quadro */
        margin-top: 20px;
        max-width: 800px;
        margin: 20px auto;
    }
	
		#cabecalho {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
        }

        #cabecalho img {
            height: 50px;
            margin-right: 20px;
        }

        #cabecalho h1 {
            font-size: 2em;
            margin: 0;
        }
	
    label { margin-top: 12px; font-weight: bold; display: block; }
    input[type="text"], input[type="number"], select {
        width: 100%;
		padding: 8px;
		margin-top: 1px;
		margin-bottom: 10px;
		box-sizing: border-box;
        border: 1px solid #ccc;
		border-radius: 4px;
		font-size: 1em;
		font-family: Arial, sans-serif;
		resize: none;
    }

	textarea {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    box-sizing: border-box;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 1em;
    font-family: Arial, sans-serif;
    resize: vertical;
	}
/* o px que tem em #comentarios depende do que tem na linha aqui em cima */
    #comentarios { height: 150px; resize: none; } 
	#comentarios_aplicaveis { height: 150px; resize: none }
	
    .editable-content {
        width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box;
        border: 1px solid #ccc; border-radius: 4px; font-size: 1em;
        min-height: 120px; background-color: #fff; position: relative;
        overflow: auto; /* Changed from hidden to auto */
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    .editable-content.short {
        min-height: 40px;
    }
    .editable-content img {
        max-width: 100%; display: block; margin-top: 5px;
    }
    
    /* Estilo para container dos campos de desenvolvimento */
    .development-field-container {
        position: relative;
        display: flex;
        align-items: flex-start;
        gap: 10px;
    }
    
    .development-field-container .editable-content {
        flex: 1;
        margin-top: 0;
    }
    
    .btn-anexar {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
        white-space: nowrap;
        margin-top: 5px;
        min-width: 80px;
    }
    
    .btn-anexar:hover {
        background-color: #0056b3;
    }
    
    /* Input file oculto */
    .file-input-hidden {
        display: none;
    }
    
    /* Estilo para drag over */
    .editable-content.drag-over {
        border: 2px dashed #007bff;
        background-color: #f8f9fa;
    }
	
    .checkbox-group { margin-top: 5px; }
    .checkbox-group label { font-weight: normal; margin-right: 15px; }
    
    button {
        margin-top: 10px;
        padding: 10px 20px;
        font-size: 1em;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        color: black;
    }
    .orange-button {
        background-color: orange;
    }
    .orange-button:hover {
        background-color: darkorange;
    }
    button.principal {
        background-color: #d4ffd6;
    }
    button.principal:hover {
        filter: brightness(90%);
    }
    button.principal.active {
        background-color: #33d439;
        color: black;
    }
    button.aplicaveis {
        background-color: #faf5be;
    }
    button.aplicaveis:hover {
        filter: brightness(90%);
    }
    button.aplicaveis.active {
        background-color: #fae743;
        color: black;
    }
    fieldset { border: 1px solid #ccc; padding: 20px; margin-top: 20px; border-radius: 8px; }
    legend { font-weight: bold; padding: 0 10px; }
    .system-block {
        border: 1px dashed #aaa; padding: 15px; margin-top: 15px;
        background-color: #f7f7f7; border-radius: 6px;
    }
    .system-block fieldset {
        background-color: #ffffff; border-radius: 6px;
    }
    .checkbox-block {
        display: flex; align-items: center; padding-bottom: 2px; margin-bottom: 2px;
    }
	.checkbox-blockk {
        display: flex; align-items: center; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 2px;
    }
	
    .checkbox-inline {
        display: flex; flex-wrap: wrap; gap: 10px; margin-top: 1px;
    }
    .checkbox-inline label { font-weight: normal; }
    .checkbox-title { text-transform: uppercase; font-weight: bold; }
    .checkbox-block .checkbox-title { margin-right: 5px; }
    input::placeholder { font-style: italic; }
    input::-webkit-input-placeholder { font-style: italic; }
    input:-moz-placeholder { font-style: italic; }
    input:-ms-input-placeholder { font-style: italic; }
    
    textarea::placeholder { font-style: italic; }
    textarea::-webkit-input-placeholder { font-style: italic; }
    textarea:-moz-placeholder { font-style: italic; }
    textarea:-ms-input-placeholder { font-style: italic; }
    
    /* Placeholder para campos contenteditable */
    .editable-content[data-placeholder].empty:before {
        content: attr(data-placeholder);
        color: #999;
        font-style: italic;
        pointer-events: none;
        position: absolute;
        top: 8px;
        left: 8px;
    }
    
    .editable-content[data-placeholder].empty:focus:before {
        display: none;
    }
	
	
	
	/* Container para campos ID DIAGRAMAS e ID FUSÍVEIS lado a lado */
	.id-fields-container {
		display: flex;
		gap: 20px;
		align-items: flex-end;
	}
	
	.id-fields-container .field-group {
		flex: 1;
	}
	
	.id-fields-container label {
		margin-bottom: 5px;
	}
	
	.id-fields-container input {
		width: 100%;
	}
	
	 .btn-paginacao {
            background-color: #ddd;
            color: #333;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-paginacao.active {
            background-color: orange; /* Cor laranja para o botão selecionado */
            color: white;
        }

        .btn-paginacao:hover {
            background-color: #ccc;
        }
	
		.btn-adicionar {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }

        .btn-adicionar:hover {
            background-color: #45a049;
        }

        .btn-remover {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .btn-remover:hover {
            background-color: #da190b;
        }
		
		.button-group-centered {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
		
		.veiculo-aplicavel-block {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
		
		.paginas-navegacao {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .paginas-navegacao .btn-paginacao {
            background-color: #ddd;
            color: #333;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .paginas-navegacao .btn-paginacao.active {
            background-color: orange;
            color: white;
        }
		
		.veiculo-aplicavel-block {
			background-color: white;
		}

    /* Estilos para o Modal de Validação */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .modal-content {
        background-color: white;
        padding: 20px 30px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        text-align: left;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
    }
    .modal-content h3 {
        margin-top: 0;
        color: #d9534f;
    }
    .modal-content ul {
        padding-left: 20px;
    }
    .modal-close-btn {
        display: block;
        margin: 20px auto 0;
        padding: 10px 25px;
        border: none;
        background-color: #f0ad4e;
        color: white;
        border-radius: 5px;
        cursor: pointer;
    }
    .campo-invalido {
        border: 2px solid red !important;
    }
    .radio-invalido {
        outline: 2px solid red;
        outline-offset: 2px;
        border-radius: 5px;
    }
	
	#text-editor-toolbar {
		flex-direction: column; /* Organiza os botões verticalmente */
		width: 45px; /* Define uma largura fixa */
		align-items: center; /* Centraliza os itens */
	}

	#text-editor-toolbar button, #text-editor-toolbar select, #text-editor-toolbar input[type="color"] {
    padding: 5px 8px;
    margin: 2px 0; /* Ajusta a margem para o layout vertical */
    border: 1px solid #ddd;
    border-radius: 3px;
    background-color: #fff;
    cursor: pointer;
    font-size: 0.9em;
	width: 100%; /* Faz os elementos preencherem a largura da barra */
    box-sizing: border-box;
	}

	/* Ajuste específico para o seletor de cor */
	#text-editor-toolbar input[type="color"] {
		height: 30px; 
		padding: 2px;
	}

	#text-editor-toolbar button:hover, #text-editor-toolbar select:hover {
		background-color: #e9e9e9;
	}

    /* ==========================================================================
       INÍCIO: ESTILOS PARA A NOVA FUNCIONALIDADE "CAIXAS"
       ========================================================================== */
    .caixa-item {
        border: 1px solid #e0e0e0;
        background-color: #fdfdfd;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 15px;
        position: relative;
    }
    .caixa-actions-column {
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: center;
        margin-top: 5px;
    }
    .btn-remover-caixa {
        background-color: #f44336;
        color: white;
        padding: 8px 12px;
        width: 100%;
		font-size: 12px;
        min-width: 80px;
        border: none;
        cursor: pointer;
    }
    .btn-remover-caixa:hover {
        background-color: #c82333;
    }
    .mover-buttons {
        display: flex;
        gap: 5px;
        width: 100%;
    }
    .btn-mover-caixa {
        background-color: #f0f0f0;
        color: #333;
        border: 1px solid #ccc;
        padding: 4px;
        font-size: 1.2em;
        line-height: 1;
        flex: 1;
        cursor: pointer;
    }
    .btn-mover-caixa:hover {
        background-color: #e0e0e0;
    }
    .btn-adicionar-caixa {
        background-color: #4CAF50;
        color: white;
        width: 100%;
    }
    .btn-adicionar-caixa:hover {
        background-color: #45a049;
    }
    /* ==========================================================================
       FIM: ESTILOS PARA A NOVA FUNCIONALIDADE "CAIXAS"
       ========================================================================== */
</style>
</head>
<body style="background-color: #f5fff5;">
     <div id="cabecalho">
        <img src="https://raw.githubusercontent.com/DSV-Hard/Planejamento/main/logo.png" alt="Logo da Empresa">
        <h1>PLANEJAMENTO</h1>
    </div>
    <div id="main-frame">
        <div style="text-align: center; margin-bottom: 20px;">
            <button id="btn-principal" class="active principal" onclick="alternarAbas('principal')">VEÍCULO PRINCIPAL</button>
            <button id="btn-aplicaveis" class="aplicaveis" onclick="alternarAbas('aplicaveis')">VEÍCULOS APLICÁVEIS</button>
        </div>
        <h2 id="aba-titulo" style="text-align: center; margin-top: 10px;">VEÍCULO PRINCIPAL</h2>

        <div id="aba-principal">
            <fieldset>			
			<legend>INFORMAÇÕES GERAIS</legend>
            <label>Planejado por</label><input type="text" id="planejado_por" placeholder="Nome completo do Desenvolvedor">
			<label>Link do Card (ClickUp)</label><input type="text" id="clickup" placeholder="https://app.clickup.com/...">
			<label>Veículo Referência</label><input type="text" id="veiculo" placeholder="Car>1994>Mazda>RX-7>1.3 256cv (13B - Wankel)">
            <div class="id-fields-container">
                <div class="field-group">
                    <label>ID DIAGRAMAS</label>
                    <input type="number" id="iddiagramas" placeholder="Apenas números">
                </div>
                <div class="field-group">
                    <label>ID FUSÍVEIS</label>
                    <input type="number" id="idfusiveis" placeholder="Apenas números">
                </div>
            </div>
            <label>PASTA DO VEÍCULO</label><input type="text" id="pasta" placeholder="P:\Desenvolvimento\+ DIAGRAMAS...">
			<div class="checkbox-block">
				<label class="checkbox-title">PESQUISA (VEÍCULO PRINCIPAL OU SEMELHANTE)</label>
				<div class="checkbox-inline" onchange="togglePesquisaTexto('principal', null)">
					<label><input type="radio" name="pesquisa" value="sim"> SIM</label>
					<label><input type="radio" name="pesquisa" value="nao" checked> NÃO</label>
				</div>
			</div>
			<textarea id="pesquisa_texto" rows="3" placeholder="I:\INFORMAÇÕES\Mazda\Pesquisa\RX-7..." style="display: none; min-height: auto;"></textarea>
			
			<div class="checkbox-blockk"></div>
			
			<label style="margin-top: 20px;">IMPORTANTE PARA O DESENVOLVIMENTO</label>
			<div class="development-field-container">
				<div contenteditable="true" class="editable-content" id="comentarios" data-field="comentarios" oninput="salvarDadosComentarios()" data-placeholder="Descreva tudo que influenciará no desenvolvimento dos manuais..."></div>
				<button type="button" class="btn-anexar" onclick="abrirSeletorArquivo('comentarios')">Anexar</button>
				<input type="file" id="file_comentarios" class="file-input-hidden" multiple accept="image/*,.pdf,.doc,.docx,.txt,.csv,.xls,.xlsx,.ppt,.pptx" onchange="processarArquivosSelecionados('comentarios', this.files)">
			</div>
			
			<div class="checkbox-blockk"></div>
			
			<div class="checkbox-block">
			<label>APLICAÇÃO / CHASSI</label>
			<div class="checkbox-inline" style="margin-bottom: 2px;">
				<label><input type="radio" name="aplicacao_chassi" value="mesma"> Mesma aplicação</label>
				<label><input type="radio" name="aplicacao_chassi" value="ajustar"> Ajustar aplicação</label>
			</div>
			</div>
			<textarea id="aplicacao_chassi_texto" rows="3" placeholder="Insira aqui a aplicação e/ou chassis do veículo." style="min-height: auto;"></textarea>
			<div style="margin-bottom: 10px; display: flex; flex-wrap: wrap; justify-content: left;">
				<button type="button" class="orange-button" onclick="window.open('http://192.168.201.220:4000/', '_blank')" style="margin-top: 5px;">Buscar chassi</button>
			</div>
			
			<div class="checkbox-blockk"></div>
			
			<label>PEDIDOS DE ILUSTRAÇÃO / TRATAMENTO DE IMAGEM</label>
			<textarea id="ilustracao_texto" rows="3" style="min-height: auto;" placeholder="P:\Desenvolvimento\+ DIAGRAMAS\0. (2026-X)\Mazda\RX-7>1.3 256cv (13B - Wankel) (1994)\Fotos e Ilustrações\Pedidos..."></textarea>
            </fieldset>
			<fieldset>
			<legend>ITENS DE SÉRIE / OPCIONAIS</legend>
			
			<!-- CHAVE / BOTÃO / ENCAIXE -->
			<div class="checkbox-block">
			  <label class="checkbox-title">TIPO DE CHAVE:</label>
			  <div class="checkbox-inline">
				<label><input type="checkbox" name="chave" value="Comum"> COMUM</label>
				<label><input type="checkbox" name="chave" value="Presencial (Botão)"> PRESENCIAL (BOTÃO)</label>
				<label><input type="checkbox" name="chave" value="Encaixe Inteligente"> ENCAIXE INTELIGENTE</label>
			  </div>
			</div>

			<div class="checkbox-blockk"></div>

			<!-- FUNÇÃO START/STOP -->
			<div class="checkbox-block">
			  <label class="checkbox-title">FUNÇÃO START/STOP:</label>
			  <div class="checkbox-inline">
				<label><input type="radio" name="startstop" value="sim_serie"> SIM (DE SÉRIE)</label>
				<label><input type="radio" name="startstop" value="sim_opcional"> SIM (OPCIONAL)</label>
				<label><input type="radio" name="startstop" value="nao"> NÃO</label>
			  </div>
			</div>

			<div class="checkbox-blockk"></div>

			<!-- AR-CONDICIONADO -->
			<div class="checkbox-block">
			  <label class="checkbox-title">AR-CONDICIONADO:</label>
			  <div class="checkbox-inline">
				<label><input type="checkbox" name="ac" value="Manual"> MANUAL</label>
				<label><input type="checkbox" name="ac" value="Automático"> AUTOMÁTICO</label>
				<label><input type="checkbox" name="ac" value="Só Ar Quente"> SÓ AR QUENTE</label>
			  </div>
			</div>

			<div class="checkbox-blockk"></div>
			
			<!-- TRANSMISSÃO -->
			<div class="checkbox-block">
			  <label class="checkbox-title">TRANSMISSÃO:</label>
			  <div class="checkbox-inline">
				<label><input type="checkbox" name="atmt" value="AT"> AT</label>
				<label><input type="checkbox" name="atmt" value="MT"> MT</label>
			  </div>
			</div>

			<div class="checkbox-blockk"></div>

			<!-- TRAÇÃO -->
			<div class="checkbox-block">
				<label class="checkbox-title">TRAÇÃO:</label>
				<div class="checkbox-inline">
					<label><input type="checkbox" name="tracao" value="4X2"> 4X2</label>
					<label><input type="checkbox" name="tracao" value="4X4"> 4X4</label>
					<label><input type="checkbox" name="tracao" value="6X2"> 6X2</label>
					<label><input type="checkbox" name="tracao" value="6X4"> 6X4</label>
					<label><input type="checkbox" name="tracao" value="8X2"> 8X2</label>
					<label><input type="checkbox" name="tracao" value="8X4"> 8X4</label>
					<label><input type="checkbox" name="tracao" value="8X8"> 8X8</label>
				</div>
			</div>
			
			<div class="checkbox-blockk"></div>
			
			<!-- ADAS -->			
			<div class="checkbox-block">
				<label class="checkbox-title">ADAS:</label>
				<div class="checkbox-inline" onchange="toggleAdasTexto('principal', null)">
					<label><input type="radio" name="adas" value="sim_serie"> SIM (DE SÉRIE)</label>
					<label><input type="radio" name="adas" value="sim_opcional"> SIM (OPCIONAL)</label>
					<label><input type="radio" name="adas" value="nao"> NÃO</label>
				</div>
			</div>
			<textarea id="adas_texto" rows="5" placeholder="Especifique..." style="display: none; min-height: auto;"></textarea>
						
			<div class="checkbox-blockk"></div>
			
			<!-- EXTRAS -->			
			<label>EXTRAS:</label><textarea id="extras" rows="3" placeholder="Teto solar, faróis de xenônio, Rádio e Multimídia, etc..."></textarea>
		
		</fieldset>

            <fieldset>
                <legend>SISTEMAS</legend>
                <div id="sistemas-container"></div>
                <div id="paginas-navegacao" style="text-align: center; margin-bottom: 10px;"></div>
                <div style="display: flex; gap: 10px; justify-content: center; margin: 10px 0;">
                    <button type="button" class="orange-button" onclick="moverSistema(-1)" title="Mover capítulo para a esquerda">←</button>
                    <button type="button" class="orange-button" onclick="moverSistema(1)" title="Mover capítulo para a direita">→</button>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                    <button type="button" class="orange-button" onclick="adicionarSistema()">➕ Adicionar Capítulo</button>
                    <button type="button" class="orange-button" onclick="removerUltimoSistema()">➖ Remover Capítulo Selecionado</button>
                </div>
            </fieldset>

            <fieldset>
                <legend>DADOS DO CARD</legend>
                <div class="card-details-block">
			<label>Dificuldade (Principal):</label>
			<select id="dificuldade">
				<option value="">Selecione a dificuldade</option>
				<option value="Fácil">FÁCIL</option>
				<option value="Médio">MÉDIO</option>
				<option value="Difícil">DIFÍCIL</option>
				<option value="Carroceria Fácil">CARROCERIA F</option>
				<option value="Carroceria Médio">CARROCERIA M</option>
				<option value="Carroceria Difícil">CARROCERIA D</option>
			</select>
			<label>Justificativa:</label><input type="text" id="justificativa" placeholder="Material difícil e muitos capítulos para diagramar do zero...">
			
		</div>
    </div>
	

	
	<div id="aba-aplicaveis" class="tab-content" style="display: none;">
    <div id="paginacao-veiculos-aplicaveis" class="paginacao-veiculos" style="text-align: center; margin-bottom: 10px;"></div>
<div class="button-group-centered">
    <button class="orange-button" onclick="adicionarVeiculoAplicavel()">➕ Adicionar Veículo</button>
    <button class="orange-button" onclick="removerUltimoVeiculoAplicavel()">➖ Remover Veículo Selecionado</button>
</div>

    <div id="veiculos-aplicaveis-container"></div>
	<div id="dados-card-aplicaveis" style="display: none;">
		<fieldset>
    <legend>DADOS DO CARD</legend>
    <label>Dificuldade (Aplicáveis):</label>
    <select id="dificuldade_aplicaveis">
        <option value="">Selecione a dificuldade</option>
        <option value="Fácil">FÁCIL</option>
        <option value="Médio">MÉDIO</option>
        <option value="Difícil">DIFÍCIL</option>
        <option value="Carroceria Fácil">CARROCERIA F</option>
        <option value="Carroceria Médio">CARROCERIA M</option>
        <option value="Carroceria Difícil">CARROCERIA D</option>
    </select>
    <label>Justificativa:</label><input type="text" id="justificativa_aplicaveis" placeholder="Material difícil e muitos capítulos para diagramar do zero...">
		</fieldset>
	</div>
</div>
</div>

    
    <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
        <input type="file" id="jsonFileInput" style="display:none" onchange="carregarDeJSON(this)">
        <button class="orange-button" onclick="document.getElementById('jsonFileInput').click()">📥 Carregar Planejamento</button>
        <button class="orange-button" onclick="salvarComoJSON()">💾 Salvar Planejamento</button>
        <button class="orange-button" onclick="gerarPDF()">📄 Gerar PDF/ZIP</button>
    </div>

    <div id="validation-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>Campos Obrigatórios</h3>
            <p>Por favor, preencha os seguintes campos antes de gerar o PDF:</p>
            <ul id="lista-campos-faltando"></ul>
            <button class="modal-close-btn" onclick="document.getElementById('validation-modal').style.display='none'">Fechar</button>
        </div>
    </div>
	
	<!-- Modal de Confirmação para Remover Capítulo -->
    <div id="confirm-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 style="color: #f0ad4e;">Confirmação de Exclusão</h3>
            <p id="confirm-modal-message">Deseja excluir o capítulo?</p>
            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
                <button class="orange-button" id="confirm-modal-yes">Sim</button>
                <button class="orange-button" id="confirm-modal-no">Não</button>
            </div>
        </div>
    </div>
	
	<!-- Modal de Cópia de Capítulo -->
    <div id="copy-chapter-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 style="color: #f0ad4e;">Copiar Capítulo de Outro Veículo</h3>
            <label for="select-veiculo-copia">De qual veículo?</label>
            <select id="select-veiculo-copia" onchange="popularCapitulosParaCopia()" style="width: 100%; margin-top: 5px; margin-bottom: 15px;"></select>
            
            <label for="select-capitulo-copia">Qual capítulo?</label>
            <select id="select-capitulo-copia" style="width: 100%; margin-top: 5px;"></select>

            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
                <button class="orange-button" onclick="executarCopiaCapitulo()">Copiar</button>
                <button class="orange-button" onclick="document.getElementById('copy-chapter-modal').style.display='none'">Cancelar</button>
            </div>
        </div>
    </div>
	
	<div id="text-editor-toolbar" style="display: none; position: absolute; background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 5px; padding: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 9999;">
		<!-- CORREÇÃO: Adicionado onmousedown="event.preventDefault()" em todos os botões e no select -->
		<button type="button" onmousedown="event.preventDefault();" onclick="formatText('bold')" title="Negrito" style="font-weight: bold;">N</button>
		<button type="button" onmousedown="event.preventDefault();" onclick="formatText('italic')" title="Itálico" style="font-style: italic;">I</button>
		<button type="button" onmousedown="event.preventDefault();" onclick="formatText('underline')" title="Sublinhado" style="text-decoration: underline;">S</button>
		<input type="color" id="text-color-picker" onmousedown="event.preventDefault();" onchange="formatTextColor(this.value)" title="Cor do Texto">
		<button type="button" onmousedown="event.preventDefault();" onclick="formatText('insertOrderedList')" title="Lista Numerada">1.</button>
		<button type="button" onmousedown="event.preventDefault();" onclick="formatText('insertUnorderedList')" title="Lista com Marcadores">•</button>
	</div>
    <script>
       let sistemasData = [];
		let paginaAtual = 0;

		let veiculosAplicaveisData = [];
		let veiculoAplicavelAtual = 0;
		let currentEditableElement = null;
		let targetVeiculoIndexParaCopia = null;

		function formatText(command, value = null) {
			if (currentEditableElement) {
				currentEditableElement.focus();
				document.execCommand(command, false, value);
			}
		}

		function formatTextColor(color) {
			formatText('foreColor', color);
		}

		function positionToolbar() {
			const toolbar = document.getElementById('text-editor-toolbar');
			if (toolbar) {
				if (currentEditableElement) {
					const rect = currentEditableElement.getBoundingClientRect();
					const topPosition = rect.top + window.scrollY;
					const leftPosition = rect.left + window.scrollX - 45 - 15;
					toolbar.style.left = `${leftPosition}px`;
					toolbar.style.top = `${topPosition}px`;
					toolbar.style.display = 'flex';
				} else {
					toolbar.style.display = 'none';
				}
			}
		}

		document.addEventListener('focusin', (e) => {
			if (e.target && e.target.classList.contains('editable-content')) {
				if (currentEditableElement !== e.target) {
					currentEditableElement = e.target;
					positionToolbar();
				}
			} else {
				const toolbar = document.getElementById('text-editor-toolbar');
				if (toolbar && !toolbar.contains(e.target)) {
					currentEditableElement = null;
					positionToolbar();
				}
			}
		});

		document.addEventListener('focusout', (e) => {
			const toolbar = document.getElementById('text-editor-toolbar');
			setTimeout(() => {
				const isFocusInsideToolbar = toolbar && toolbar.contains(document.activeElement);
				const isFocusInsideEditableContent = document.activeElement && document.activeElement.classList.contains('editable-content');
				
				if (!isFocusInsideToolbar && !isFocusInsideEditableContent) {
					currentEditableElement = null;
					positionToolbar();
				}
			}, 100);
		});

		window.addEventListener('scroll', positionToolbar);
		window.addEventListener('resize', positionToolbar);

		function setupEditableContent(elementId) {
			const element = document.getElementById(elementId);
			if (!element) return;

			updateEditablePlaceholder(element);
			autoResizeEditableContent(element);

			element.addEventListener('input', () => {
				updateEditablePlaceholder(element);
				autoResizeEditableContent(element);
				if (element.oninput) {
					element.oninput(); 
				}
			});

			element.addEventListener('paste', async function (e) {
				e.preventDefault();
				
				const clipboardData = e.clipboardData || window.clipboardData;
				let contentInserted = false;

				if (clipboardData.files.length > 0) {
					const file = clipboardData.files[0];
					if (file.type.indexOf('image') !== -1) { 
						await processarArquivo(element, file);
						contentInserted = true;
					}
				}

				if (!contentInserted) {
					const html = clipboardData.getData('text/html');
					const text = clipboardData.getData('text/plain');

					if (html) {
						document.execCommand('insertHTML', false, html);
						contentInserted = true;
					} 
					else if (text) {
						const urlRegex = /(https?:\/\/[^\s]+)|(www\.[^\s]+)/g;
						
						if (text.match(urlRegex)) {
							let newContent = text.replace(urlRegex, (url) => {
								const fullUrl = url.startsWith('http') ? url : `http://${url}`;
								return `<a href="${fullUrl}" target="_blank">LINK</a>`;
							});
							document.execCommand('insertHTML', false, newContent);
						} else {
							document.execCommand('insertText', false, text);
						}
						contentInserted = true;
					}
				}
				
				if (element.oninput) {
					element.oninput();
				}
			});
		}

		function atualizarVisibilidadeDadosCardAplicaveis() {
			const card = document.getElementById('dados-card-aplicaveis');
			const container = document.getElementById('veiculos-aplicaveis-container');
			if (!card || !container) return;
			const temBlocoVisivel = (container.innerHTML || '').trim().length > 0;
			const temVeiculos = Array.isArray(veiculosAplicaveisData) && veiculosAplicaveisData.length > 0;
			card.style.display = (temVeiculos && temBlocoVisivel) ? 'block' : 'none';
		}

		function extrairTooltipVeiculo(veiculoStr) {
			if (!veiculoStr || typeof veiculoStr !== 'string') return '';
			if (veiculoStr.includes('>')) {
				const partes = veiculoStr.split('>');
				if (partes.length >= 5) {
					const ano = partes[1].trim();
					const modelo = partes[3].trim();
					const motor = partes[4].trim();
					return `${ano} ${modelo} ${motor}`;
				}
			}
			return veiculoStr;
		}

		function alternarAbas(aba) {
			const abaPrincipal = document.getElementById('aba-principal');
			const abaAplicaveis = document.getElementById('aba-aplicaveis');
			const btnPrincipal = document.getElementById('btn-principal');
			const btnAplicaveis = document.getElementById('btn-aplicaveis');
			const abaTitulo = document.getElementById('aba-titulo');
			const body = document.body;

			if (aba === 'principal') {
				abaPrincipal.style.display = 'block';
				abaAplicaveis.style.display = 'none';
				btnPrincipal.classList.add('active');
				btnAplicaveis.classList.remove('active');
				abaTitulo.textContent = 'VEÍCULO PRINCIPAL';
				body.style.backgroundColor = '#d7fcd7';
			} else {
				abaPrincipal.style.display = 'none';
				abaAplicaveis.style.display = 'block';
				btnPrincipal.classList.remove('active');
				btnAplicaveis.classList.add('active');
				abaTitulo.textContent = 'VEÍCULOS APLICÁVEIS';
				body.style.backgroundColor = '#ffffd1';
			}
		}

		function togglePesquisaTexto(type, index) {
			let radioSelector, textareaId;
			if (type === 'principal') {
				radioSelector = 'input[name="pesquisa"]:checked';
				textareaId = 'pesquisa_texto';
			} else {
				radioSelector = `input[name="pesquisa_aplicaveis_${index}"]:checked`;
				textareaId = `pesquisa_texto_aplicaveis_${index}`;
			}

			const radio = document.querySelector(radioSelector);
			const textarea = document.getElementById(textareaId);

			if (radio && textarea) {
				textarea.style.display = (radio.value === 'sim') ? 'block' : 'none';
			}
		}

		function toggleAdasTexto(type, index) {
			let radioSelector, textareaId;
			if (type === 'principal') {
				radioSelector = 'input[name="adas"]:checked';
				textareaId = 'adas_texto';
			} else {
				radioSelector = `input[name="adas_aplicaveis_${index}"]:checked`;
				textareaId = `adas_texto_aplicaveis_${index}`;
			}

			const radio = document.querySelector(radioSelector);
			const textarea = document.getElementById(textareaId);

			if (radio && textarea) {
				textarea.style.display = (radio.value === 'sim_serie' || radio.value === 'sim_opcional') ? 'block' : 'none';
			}
		}

		function renderizarFormularioCapitulo(idx) {
			const select = document.getElementById(`sistema_${idx}`);
			const valor = select.value;
			const container = document.getElementById(`formulario-capitulo_${idx}`);
			const dados = sistemasData[idx];

			container.innerHTML = ""; // limpa antes

			if (!valor) return;

			const isCaixasForm = valor === "Fusíveis e Relés";
			const isPaginasForm = valor === "Alimentação Positiva" || valor === "Conectores de Peito";

			if (isCaixasForm || isPaginasForm) {
				const commonHtml = `
					<div class="checkbox-block">
						<div class="checkbox-inline" onchange="toggleIdTransfPrincipal(${idx}); togglePaginasPrevistaPrincipal(${idx}); salvarDadosSistema(${idx})">
							<label><input type="radio" name="transferencia_${idx}" value="zero" ${dados.transferencia === 'zero' ? 'checked' : ''}> Fazer do Zero</label>
							<label><input type="radio" name="transferencia_${idx}" value="transferencia" ${dados.transferencia === 'transferencia' ? 'checked' : ''}> Transferência</label>
							<label><input type="radio" name="transferencia_${idx}" value="modificar" ${dados.transferencia === 'modificar' ? 'checked' : ''}> Modificar Publicado</label>
						</div>
					</div>
					<input type="number" id="idtransf_${idx}" name="idtransf_${idx}" placeholder="Informe o ID..." value="${dados.idtransf || ''}" style="display: ${dados.transferencia === 'transferencia' ? 'block' : 'none'}" onchange="salvarDadosSistema(${idx})">
					
					<div data-container-for="paginasprev_${idx}" style="display: ${dados.transferencia === 'modificar' ? 'none' : 'block'}">
						<label>Nº páginas prevista</label>
						<input type="number" name="paginasprev_${idx}" value="${dados.paginasprev || ''}" placeholder="Apenas números" oninput="this.value = this.value.replace(/[^0-9]/g, ''); salvarDadosSistema(${idx})">
					</div>
				`;

				const buttonText = isCaixasForm ? "+ Adicionar Caixa" : "+ Adicionar Página";
				const buttonAction = isCaixasForm ? `adicionarCaixa(${idx})` : `adicionarPagina(${idx})`;

				container.innerHTML = commonHtml + `
					<fieldset>
						<legend>DESENVOLVIMENTO</legend>
						<div id="dynamic-content-container_${idx}"></div>
						<button type="button" class="btn-adicionar-caixa" onclick="${buttonAction}">${buttonText}</button>
					</fieldset>
				`;

				if (isCaixasForm) {
					renderizarCaixas(idx);
				} else {
					renderizarPaginas(idx);
				}
			} else {
				// 🔹 Formulário padrão para os outros sistemas
				container.innerHTML = `
					<div class="checkbox-block">
						<div class="checkbox-inline" onchange="toggleIdTransfPrincipal(${idx}); togglePaginasPrevistaPrincipal(${idx}); salvarDadosSistema(${idx})">
							<label><input type="radio" name="transferencia_${idx}" value="zero" ${dados.transferencia === 'zero' ? 'checked' : ''}> Fazer do Zero</label>
							<label><input type="radio" name="transferencia_${idx}" value="transferencia" ${dados.transferencia === 'transferencia' ? 'checked' : ''}> Transferência</label>
							<label><input type="radio" name="transferencia_${idx}" value="modificar" ${dados.transferencia === 'modificar' ? 'checked' : ''}> Modificar Publicado</label>
						</div>
					</div>
					<input type="number" id="idtransf_${idx}" name="idtransf_${idx}" placeholder="Informe o ID..." value="${dados.idtransf || ''}" style="display: ${dados.transferencia === 'transferencia' ? 'block' : 'none'}" onchange="salvarDadosSistema(${idx})">
					
					<div data-container-for="paginasprev_${idx}" style="display: ${dados.transferencia === 'modificar' ? 'none' : 'block'}">
						<label>Nº páginas prevista</label>
						<input type="number" name="paginasprev_${idx}" value="${dados.paginasprev || ''}" placeholder="Apenas números" oninput="this.value = this.value.replace(/[^0-9]/g, ''); salvarDadosSistema(${idx})">
					</div>

					<label>Módulo principal</label>
					<input type="text" name="modulo_${idx}" value="${dados.modulo || ''}" placeholder="UCE do Motor" onchange="salvarDadosSistema(${idx})">

					<label>Nome no material</label>
					<input type="text" name="nomematerial_${idx}" value="${dados.nomematerial || ''}" placeholder="Engine Control Unit" onchange="salvarDadosSistema(${idx})">

					<label>Código de Peça / Link</label>
					<div contenteditable="true" class="editable-content short" id="codmodulo_${idx}" data-field="codmodulo" oninput="salvarDadosSistema(${idx})">${dados.codmodulo || ''}</div>

					<label>Códigos de Conectores</label>
					<textarea name="codconectores_${idx}" rows="3" placeholder="T20 = A / LB = B / T50d = C" onchange="salvarDadosSistema(${idx})">${dados.codconectores || ''}</textarea>

					<fieldset>
						<legend>DESENVOLVIMENTO</legend>
						<label>Página de Localização</label>
						<div class="development-field-container">
							<div contenteditable="true" class="editable-content" id="pagloc_${idx}" data-field="pagloc" oninput="salvarDadosSistema(${idx})">${dados.pagloc || ''}</div>
							<button type="button" class="btn-anexar" onclick="abrirSeletorArquivo('pagloc_${idx}')">Anexar</button>
							<input type="file" id="file_pagloc_${idx}" class="file-input-hidden" multiple accept="image/*,.pdf,.doc,.docx,.txt,.csv,.xls,.xlsx,.ppt,.pptx" onchange="processarArquivosSelecionados('pagloc_${idx}', this.files)">
						</div>

						<label>Página de Conectores</label>
						<div class="development-field-container">
							<div contenteditable="true" class="editable-content" id="pagcon_${idx}" data-field="pagcon" oninput="salvarDadosSistema(${idx})">${dados.pagcon || ''}</div>
							<button type="button" class="btn-anexar" onclick="abrirSeletorArquivo('pagcon_${idx}')">Anexar</button>
							<input type="file" id="file_pagcon_${idx}" class="file-input-hidden" multiple accept="image/*,.pdf,.doc,.docx,.txt,.csv,.xls,.xlsx,.ppt,.pptx" onchange="processarArquivosSelecionados('pagcon_${idx}', this.files)">
						</div>

						<label>Página de Diagramas</label>
						<div class="development-field-container">
							<div contenteditable="true" class="editable-content" id="pagdiag_${idx}" data-field="pagdiag" oninput="salvarDadosSistema(${idx})">${dados.pagdiag || ''}</div>
							<button type="button" class="btn-anexar" onclick="abrirSeletorArquivo('pagdiag_${idx}')">Anexar</button>
							<input type="file" id="file_pagdiag_${idx}" class="file-input-hidden" multiple accept="image/*,.pdf,.doc,.docx,.txt,.csv,.xls,.xlsx,.ppt,.pptx" onchange="processarArquivosSelecionados('pagdiag_${idx}', this.files)">
						</div>
					</fieldset>
				`;
			}
			
			if (!isCaixasForm && !isPaginasForm) {
                setupDragAndDrop(`pagloc_${idx}`);
                setupEditableContent(`pagloc_${idx}`);
				setupEditableContent(`codmodulo_${idx}`);
				setupDragAndDrop(`pagcon_${idx}`);
				setupEditableContent(`pagcon_${idx}`);
				setupDragAndDrop(`pagdiag_${idx}`);
				setupEditableContent(`pagdiag_${idx}`);
			}
		}
        
        function adicionarCaixa(sistemaIndex) {
            const dados = sistemasData[sistemaIndex];
            if (!dados.caixas) dados.caixas = [];
            dados.caixas.push({ nome: '', descricoes: '' });
            renderizarCaixas(sistemaIndex);
        }

        function removerCaixa(sistemaIndex, caixaIndex) {
            sistemasData[sistemaIndex].caixas.splice(caixaIndex, 1);
            renderizarCaixas(sistemaIndex);
        }

        function moverCaixa(sistemaIndex, caixaIndex, direcao) {
            const caixas = sistemasData[sistemaIndex].caixas;
            const newIndex = caixaIndex + direcao;
            if (newIndex < 0 || newIndex >= caixas.length) return;
            const itemMovido = caixas.splice(caixaIndex, 1)[0];
            caixas.splice(newIndex, 0, itemMovido);
            renderizarCaixas(sistemaIndex);
        }

        function renderizarCaixas(sistemaIndex) {
            const container = document.getElementById(`dynamic-content-container_${sistemaIndex}`);
            if (!container) return;
            const caixas = sistemasData[sistemaIndex].caixas || [];
            container.innerHTML = '';
            caixas.forEach((caixa, i) => {
                const descId = `descricoes_${sistemaIndex}_${i}`;
                const caixaDiv = document.createElement('div');
                caixaDiv.className = 'caixa-item';
                caixaDiv.innerHTML = `
                    <label for="nome_caixa_${sistemaIndex}_${i}">Nome da Caixa</label>
                    <input type="text" id="nome_caixa_${sistemaIndex}_${i}" value="${caixa.nome || ''}" oninput="sistemasData[${sistemaIndex}].caixas[${i}].nome = this.value" placeholder="Ex: Caixa de Fusíveis do Painel">
                    <label for="${descId}">Descrições</label>
                    <div class="development-field-container">
                        <div contenteditable="true" class="editable-content" id="${descId}" data-placeholder="Insira imagens, documentos ou texto...">${caixa.descricoes || ''}</div>
                        <div class="caixa-actions-column">
                            <button type="button" class="btn-anexar" onclick="abrirSeletorArquivo('${descId}')">Anexar</button>
                            <input type="file" id="file_${descId}" class="file-input-hidden" multiple accept="image/*,.pdf,.doc,.docx,.txt,.csv,.xls,.xlsx,.ppt,.pptx" onchange="processarArquivosSelecionados('${descId}', this.files)">
                            <button type="button" class="btn-remover-caixa" onclick="removerCaixa(${sistemaIndex}, ${i})">- Remover</button>
                            <div class="mover-buttons">
                                <button type="button" class="btn-mover-caixa" onclick="moverCaixa(${sistemaIndex}, ${i}, -1)" title="Mover para cima">▲</button>
                                <button type="button" class="btn-mover-caixa" onclick="moverCaixa(${sistemaIndex}, ${i}, 1)" title="Mover para baixo">▼</button>
                            </div>
                        </div>
                    </div>`;
                container.appendChild(caixaDiv);
                const descElement = document.getElementById(descId);
                descElement.oninput = () => { sistemasData[sistemaIndex].caixas[i].descricoes = descElement.innerHTML; };
                setupDragAndDrop(descId);
                setupEditableContent(descId);
            });
        }

		function adicionarPagina(sistemaIndex) {
            const dados = sistemasData[sistemaIndex];
            if (!dados.paginas) dados.paginas = [];
            dados.paginas.push({ conteudo: '' });
            renderizarPaginas(sistemaIndex);
        }

        function removerPagina(sistemaIndex, paginaIndex) {
            sistemasData[sistemaIndex].paginas.splice(paginaIndex, 1);
            renderizarPaginas(sistemaIndex);
        }

        function moverPagina(sistemaIndex, paginaIndex, direcao) {
            const paginas = sistemasData[sistemaIndex].paginas;
            const newIndex = paginaIndex + direcao;
            if (newIndex < 0 || newIndex >= paginas.length) return;
            const itemMovido = paginas.splice(paginaIndex, 1)[0];
            paginas.splice(newIndex, 0, itemMovido);
            renderizarPaginas(sistemaIndex);
        }

        function renderizarPaginas(sistemaIndex) {
            const container = document.getElementById(`dynamic-content-container_${sistemaIndex}`);
            if (!container) return;
            const paginas = sistemasData[sistemaIndex].paginas || [];
            container.innerHTML = '';
            paginas.forEach((pagina, i) => {
                const descId = `descricoes_pagina_${sistemaIndex}_${i}`;
                const paginaDiv = document.createElement('div');
                paginaDiv.className = 'caixa-item';
                paginaDiv.innerHTML = `
                    <label for="${descId}">Página ${i + 1}</label>
                    <div class="development-field-container">
                        <div contenteditable="true" class="editable-content" id="${descId}" data-placeholder="Insira imagens, documentos ou texto...">${pagina.conteudo || ''}</div>
                        <div class="caixa-actions-column">
                            <button type="button" class="btn-anexar" onclick="abrirSeletorArquivo('${descId}')">Anexar</button>
                            <input type="file" id="file_${descId}" class="file-input-hidden" multiple accept="image/*,.pdf,.doc,.docx,.txt,.csv,.xls,.xlsx,.ppt,.pptx" onchange="processarArquivosSelecionados('${descId}', this.files)">
                            <button type="button" class="btn-remover-caixa" onclick="removerPagina(${sistemaIndex}, ${i})">- Remover</button>
                            <div class="mover-buttons">
                                <button type="button" class="btn-mover-caixa" onclick="moverPagina(${sistemaIndex}, ${i}, -1)" title="Mover para cima">▲</button>
                                <button type="button" class="btn-mover-caixa" onclick="moverPagina(${sistemaIndex}, ${i}, 1)" title="Mover para baixo">▼</button>
                            </div>
                        </div>
                    </div>`;
                container.appendChild(paginaDiv);
                const descElement = document.getElementById(descId);
                descElement.oninput = () => { sistemasData[sistemaIndex].paginas[i].conteudo = descElement.innerHTML; };
                setupDragAndDrop(descId);
                setupEditableContent(descId);
            });
        }

		function renderizarFormularioCapituloAplicaveis(veiculoIndex, sistemaIndex) {
			const select = document.getElementById(`sistema_aplicaveis_${veiculoIndex}_${sistemaIndex}`);
			const valor = select.value;
			const container = document.getElementById(`formulario-capitulo-aplicaveis_${veiculoIndex}_${sistemaIndex}`);
			const veiculo = veiculosAplicaveisData[veiculoIndex];
			const dados = veiculo.sistemas[sistemaIndex];

			container.innerHTML = ""; // Limpa o container antes de adicionar o novo formulário

			if (!valor) return;

			const isCaixasForm = valor === "Fusíveis e Relés";
			const isPaginasForm = valor === "Alimentação Positiva" || valor === "Conectores de Peito";

			if (isCaixasForm || isPaginasForm) {
				const commonHtml = `
					<div class="checkbox-block">
						<div class="checkbox-inline" onchange="toggleIdTransfAplicaveis(${veiculoIndex}, ${sistemaIndex}); togglePaginasPrevistaAplicaveis(${veiculoIndex}, ${sistemaIndex}); salvarDadosSistemaAplicaveis(${veiculoIndex}, ${sistemaIndex})">
							<label><input type="radio" name="transferencia_aplicaveis_${veiculoIndex}_${sistemaIndex}" value="transferencia_principal" ${dados.transferencia === 'transferencia_principal' ? 'checked' : ''}> Transferência (do Principal)</label>
							<label><input type="radio" name="transferencia_aplicaveis_${veiculoIndex}_${sistemaIndex}" value="transferencia_outro" ${dados.transferencia === 'transferencia_outro' ? 'checked' : ''}> Transferência (Outro)</label>
							<label><input type="radio" name="transferencia_aplicaveis_${veiculoIndex}_${sistemaIndex}" value="modificar" ${dados.transferencia === 'modificar' ? 'checked' : ''}> Modificar Publicado</label>
						</div>
					</div>
					<input type="number" id="idtransf_aplicaveis_${veiculoIndex}_${sistemaIndex}" name="idtransf_aplicaveis_${veiculoIndex}_${sistemaIndex}" placeholder="Informe o ID..." value="${dados.idtransf || ''}" style="display: ${dados.transferencia === 'transferencia_outro' ? 'block' : 'none'}" onchange="salvarDadosSistemaAplicaveis(${veiculoIndex}, ${sistemaIndex})">
					<div data-container-for="paginasprev_aplicaveis_${veiculoIndex}_${sistemaIndex}" style="display: ${dados.transferencia === 'modificar' ? 'none' : 'block'}">
						<label>Nº páginas prevista</label>
						<input type="number" name="paginasprev_aplicaveis_${veiculoIndex}_${sistemaIndex}" value="${dados.paginasprev || ''}" placeholder="Apenas números" oninput="this.value = this.value.replace(/[^0-9]/g, ''); salvarDadosSistemaAplicaveis(${veiculoIndex}, ${sistemaIndex})">
					</div>`;
				
				const buttonText = isCaixasForm ? "+ Adicionar Caixa" : "+ Adicionar Página";
				const buttonAction = isCaixasForm ? `adicionarCaixaAplicaveis(${veiculoIndex}, ${sistemaIndex})` : `adicionarPaginaAplicaveis(${veiculoIndex}, ${sistemaIndex})`;

				container.innerHTML = commonHtml + `
					<fieldset>
						<legend>DESENVOLVIMENTO</legend>
						<div id="dynamic-content-container-aplicaveis_${veiculoIndex}_${sistemaIndex}"></div>
						<button type="button" class="btn-adicionar-caixa" onclick="${buttonAction}">${buttonText}</button>
					</fieldset>
				`;

				if (isCaixasForm) {
					renderizarCaixasAplicaveis(veiculoIndex, sistemaIndex);
				} else {
					renderizarPaginasAplicaveis(veiculoIndex, sistemaIndex);
				}
			} else {
					// Formulário PADRÃO
					container.innerHTML = `
						<div class="checkbox-block">
							<div class="checkbox-inline" onchange="toggleIdTransfAplicaveis(${veiculoIndex}, ${sistemaIndex}); togglePaginasPrevistaAplicaveis(${veiculoIndex}, ${sistemaIndex}); salvarDadosSistemaAplicaveis(${veiculoIndex}, ${sistemaIndex})">
								<label><input type="radio" name="transferencia_aplicaveis_${veiculoIndex}_${sistemaIndex}" value="transferencia_principal" ${dados.transferencia === 'transferencia_principal' ? 'checked' : ''}> Transferência (do Principal)</label>
								<label><input type="radio" name="transferencia_aplicaveis_${veiculoIndex}_${sistemaIndex}" value="transferencia_outro" ${dados.transferencia === 'transferencia_outro' ? 'checked' : ''}> Transferência (Outro)</label>
								<label><input type="radio" name="transferencia_aplicaveis_${veiculoIndex}_${sistemaIndex}" value="modificar" ${dados.transferencia === 'modificar' ? 'checked' : ''}> Modificar Publicado</label>
							</div>
						</div>
						<input type="number" id="idtransf_aplicaveis_${veiculoIndex}_${sistemaIndex}" name="idtransf_aplicaveis_${veiculoIndex}_${sistemaIndex}" placeholder="Informe o ID..." value="${dados.idtransf || ''}" style="display: ${dados.transferencia === 'transferencia_outro' ? 'block' : 'none'}" onchange="salvarDadosSistemaAplicaveis(${veiculoIndex}, ${sistemaIndex})">
						
						<div data-container-for="paginasprev_aplicaveis_${veiculoIndex}_${sistemaIndex}" style="display: ${dados.transferencia === 'modificar' ? 'none' : 'block'}">
							<label>Nº páginas prevista</label>
							<input type="number" name="paginasprev_aplicaveis_${veiculoIndex}_${sistemaIndex}" value="${dados.paginasprev || ''}" placeholder="Apenas números" oninput="this.value = this.value.replace(/[^0-9]/g, ''); salvarDadosSistemaAplicaveis(${veiculoIndex}, ${sistemaIndex})">
						</div>
						
						<label>Módulo principal</label><input type="text" name="modulo_aplicaveis_${veiculoIndex}_${sistemaIndex}" value="${dados.modulo || ''}" placeholder="UCE do Motor" onchange="salvarDadosSistemaAplicaveis(${veiculoIndex}, ${sistemaIndex})">
						<label>Nome no material</label><input type="text" name="nomematerial_aplicaveis_${veiculoIndex}_${sistemaIndex}" value="${dados.nomematerial || ''}" placeholder="Engine Control Unit" onchange="salvarDadosSistemaAplicaveis(${veiculoIndex}, ${sistemaIndex})">
						<label>Código de Peça / Link</label>
						<div contenteditable="true" class="editable-content short" id="codmodulo_aplicaveis_${veiculoIndex}_${sistemaIndex}" data-field="codmodulo_aplicaveis" oninput="salvarDadosSistemaAplicaveis(${veiculoIndex}, ${sistemaIndex})">${dados.codmodulo || ''}</div>
						<label>Códigos de Conectores</label><textarea name="codconectores_aplicaveis_${veiculoIndex}_${sistemaIndex}" rows="3" placeholder="T20 = A / LB = B / T50d = C" onchange="salvarDadosSistemaAplicaveis(${veiculoIndex}, ${sistemaIndex})">${dados.codconectores || ''}</textarea>
						
						<fieldset>
							<legend>DESENVOLVIMENTO</legend>
							<label>Página de Localização</label>
							<div class="development-field-container">
								<div contenteditable="true" class="editable-content" id="pagloc_aplicaveis_${veiculoIndex}_${sistemaIndex}" data-field="pagloc_aplicaveis" oninput="salvarDadosSistemaAplicaveis(${veiculoIndex}, ${sistemaIndex})">${dados.pagloc || ''}</div>
								<button type="button" class="btn-anexar" onclick="abrirSeletorArquivo('pagloc_aplicaveis_${veiculoIndex}_${sistemaIndex}')">Anexar</button>
								<input type="file" id="file_pagloc_aplicaveis_${veiculoIndex}_${sistemaIndex}" class="file-input-hidden" multiple accept="image/*,.pdf,.doc,.docx,.txt,.csv,.xls,.xlsx,.ppt,.pptx" onchange="processarArquivosSelecionados('pagloc_aplicaveis_${veiculoIndex}_${sistemaIndex}', this.files)">
							</div>
							<label>Página de Conectores</label>
							<div class="development-field-container">
								<div contenteditable="true" class="editable-content" id="pagcon_aplicaveis_${veiculoIndex}_${sistemaIndex}" data-field="pagcon_aplicaveis" oninput="salvarDadosSistemaAplicaveis(${veiculoIndex}, ${sistemaIndex})">${dados.pagcon || ''}</div>
								<button type="button" class="btn-anexar" onclick="abrirSeletorArquivo('pagcon_aplicaveis_${veiculoIndex}_${sistemaIndex}')">Anexar</button>
								<input type="file" id="file_pagcon_aplicaveis_${veiculoIndex}_${sistemaIndex}" class="file-input-hidden" multiple accept="image/*,.pdf,.doc,.docx,.txt,.csv,.xls,.xlsx,.ppt,.pptx" onchange="processarArquivosSelecionados('pagcon_aplicaveis_${veiculoIndex}_${sistemaIndex}', this.files)">
							</div>
							<label>Página de Diagramas</label>
							<div class="development-field-container">
								<div contenteditable="true" class="editable-content" id="pagdiag_aplicaveis_${veiculoIndex}_${sistemaIndex}" data-field="pagdiag_aplicaveis" oninput="salvarDadosSistemaAplicaveis(${veiculoIndex}, ${sistemaIndex})">${dados.pagdiag || ''}</div>
								<button type="button" class="btn-anexar" onclick="abrirSeletorArquivo('pagdiag_aplicaveis_${veiculoIndex}_${sistemaIndex}')">Anexar</button>
								<input type="file" id="file_pagdiag_aplicaveis_${veiculoIndex}_${sistemaIndex}" class="file-input-hidden" multiple accept="image/*,.pdf,.doc,.docx,.txt,.csv,.xls,.xlsx,.ppt,.pptx" onchange="processarArquivosSelecionados('pagdiag_aplicaveis_${veiculoIndex}_${sistemaIndex}', this.files)">
							</div>
						</fieldset>
					`;
				}

			if (!isCaixasForm && !isPaginasForm) {
				setupDragAndDrop(`pagloc_aplicaveis_${veiculoIndex}_${sistemaIndex}`);
				setupEditableContent(`pagloc_aplicaveis_${veiculoIndex}_${sistemaIndex}`);
				setupEditableContent(`codmodulo_aplicaveis_${veiculoIndex}_${sistemaIndex}`);
				setupDragAndDrop(`pagcon_aplicaveis_${veiculoIndex}_${sistemaIndex}`);
				setupEditableContent(`pagcon_aplicaveis_${veiculoIndex}_${sistemaIndex}`);
				setupDragAndDrop(`pagdiag_aplicaveis_${veiculoIndex}_${sistemaIndex}`);
				setupEditableContent(`pagdiag_aplicaveis_${veiculoIndex}_${sistemaIndex}`);
			}
			
			toggleIdTransfAplicaveis(veiculoIndex, sistemaIndex);
		}

		function renderizarSistema(index) {
				const container = document.getElementById("sistemas-container");
				container.innerHTML = "";
				if (sistemasData.length === 0) return;

				const dados = sistemasData[index];
				const div = document.createElement("div");
				div.className = "system-block";
				const idx = index;

				// Campo de seleção do sistema
				div.innerHTML = `
				<label>Título do capítulo</label>
					<select name="sistema_${idx}" id="sistema_${idx}" onchange="salvarDadosSistema(${idx}); renderizarFormularioCapitulo(${idx});">
						<option value="">Selecione</option>
						<option value="Alimentação Positiva" ${dados.sistema === 'Alimentação Positiva' ? 'selected' : ''}>Alimentação Positiva</option>
						<option value="Conectores de Peito" ${dados.sistema === 'Conectores de Peito' ? 'selected' : ''}>Conectores de Peito</option>
						<option value="Fusíveis e Relés" ${dados.sistema === 'Fusíveis e Relés' ? 'selected' : ''}>Fusíveis e Relés</option>
						<option value="Central de Carroceria" ${dados.sistema === 'Central de Carroceria' ? 'selected' : ''}>Central de Carroceria</option>
						<option value="Injeção Eletrônica" ${dados.sistema === 'Injeção Eletrônica' ? 'selected' : ''}>Injeção Eletrônica</option>
						<option value="Sistema de Carga e Partida" ${dados.sistema === 'Sistema de Carga e Partida' ? 'selected' : ''}>Sistema de Carga e Partida</option>
						<option value="Injeção Eletrônica e Transmissão" ${dados.sistema === 'Injeção Eletrônica e Transmissão' ? 'selected' : ''}>Injeção Eletrônica e Transmissão</option>
						<option value="Transmissão Automática" ${dados.sistema === 'Transmissão Automática' ? 'selected' : ''}>Transmissão Automática</option>
						<option value="Tração 4x4" ${dados.sistema === 'Tração 4x4' ? 'selected' : ''}>Tração 4x4</option>
						<option value="Redes de Comunicação" ${dados.sistema === 'Redes de Comunicação' ? 'selected' : ''}>Redes de Comunicação</option>
						<option value="Painel de Instrumentos" ${dados.sistema === 'Painel de Instrumentos' ? 'selected' : ''}>Painel de Instrumentos</option>
						<option value="Airbag" ${dados.sistema === 'Airbag' ? 'selected' : ''}>Airbag</option>
						<option value="Ar-condicionado" ${dados.sistema === 'Ar-condicionado' ? 'selected' : ''}>Ar-condicionado</option>
						<option value="Freio ABS" ${dados.sistema === 'Freio ABS' ? 'selected' : ''}>Freio ABS</option>
						<option value="Freio de Estacionamento Eletrônico" ${dados.sistema === 'Freio de Estacionamento Eletrônico' ? 'selected' : ''}>Freio de Estacionamento Eletrônico</option>
						<option value="Rádio" ${dados.sistema === 'Rádio' ? 'selected' : ''}>Rádio</option>
						<option value="Central Multimídia" ${dados.sistema === 'Central Multimídia' ? 'selected' : ''}>Central Multimídia</option>
						<option value="Iluminação Interna e Externa" ${dados.sistema === 'Iluminação' ? 'selected' : ''}>Iluminação Interna e Externa</option>
						<option value="Outro" ${dados.sistema && ![
							'Fusíveis e Relés','Alimentação Positiva','Conectores de Peito','Central de Carroceria','Injeção Eletrônica',
							'Sistema de Carga e Partida','Injeção Eletrônica e Transmissão','Transmissão Automática',
							'Tração 4x4','Redes de Comunicação','Painel de Instrumentos','Airbag','Ar-condicionado',
							'Freio ABS','Freio de Estacionamento Eletrônico','Rádio','Central Multimídia','Iluminação Interna e Externa'
						].includes(dados.sistema) ? 'selected' : ''}>Outro</option>
					</select>
					<div id="outrocampo_${idx}" style="display:none; margin-top: 5px;">
						<label>Especifique o título:</label>
						<input type="text" name="sistema_outro_${idx}" value="${dados.sistema && ![
							'Fusíveis e Relés','Alimentação Positiva','Conectores de Peito','Central de Carroceria','Injeção Eletrônica',
							'Sistema de Carga e Partida','Injeção Eletrônica e Transmissão','Transmissão Automática',
							'Tração 4x4','Redes de Comunicação','Painel de Instrumentos','Airbag','Ar-condicionado',
							'Freio ABS','Freio de Estacionamento Eletrônico','Rádio','Central Multimídia','Iluminação'
						].includes(dados.sistema) ? dados.sistema : ''}" onchange="salvarDadosSistema(${idx})">
					</div>
					<div id="formulario-capitulo_${idx}"></div>
				`;

				container.appendChild(div);

				// Lógica para mostrar/esconder o campo "Outro"
				const selectElement = div.querySelector(`#sistema_${idx}`);
				const outroCampo = div.querySelector(`#outrocampo_${idx}`);
				const outroInput = div.querySelector(`input[name="sistema_outro_${idx}"]`);

				const toggleOutroCampo = () => {
					if (selectElement.value === 'Outro' || (selectElement.value === '' && outroInput.value)) {
						outroCampo.style.display = 'block';
					} else {
						outroCampo.style.display = 'none';
					}
				};

				selectElement.addEventListener('change', toggleOutroCampo);
				toggleOutroCampo(); 

				if (dados.sistema) {
					renderizarFormularioCapitulo(idx);
				}
			}

		function toggleIdTransfPrincipal(index) {
			const radio = document.querySelector(`input[name="transferencia_${index}"]:checked`);
			const idTransfInput = document.getElementById(`idtransf_${index}`);

			if (radio && idTransfInput) {
				idTransfInput.style.display = (radio.value === 'transferencia') ? 'block' : 'none';
			}
		}

		function togglePaginasPrevistaPrincipal(index) {
			const radio = document.querySelector(`input[name="transferencia_${index}"]:checked`);
			const container = document.querySelector(`[data-container-for='paginasprev_${index}']`);
			if (radio && container) {
				container.style.display = (radio.value === 'modificar') ? 'none' : 'block';
			}
		}

		function togglePaginasPrevistaAplicaveis(veiculoIndex, sistemaIndex) {
			const radio = document.querySelector(`input[name="transferencia_aplicaveis_${veiculoIndex}_${sistemaIndex}"]:checked`);
			const container = document.querySelector(`[data-container-for='paginasprev_aplicaveis_${veiculoIndex}_${sistemaIndex}']`);
			if (radio && container) {
				container.style.display = (radio.value === 'modificar') ? 'none' : 'block';
			}
		}
		
		function adicionarSistema() {
			const sistemasContainer = document.getElementById('sistemas-container');
			if (sistemasData.length > 0) salvarDadosSistema(paginaAtual);
			sistemasData.push({});
			renderizarPaginacao();
			mostrarPagina(sistemasData.length - 1);
		}

		function moverSistema(direcao) {
            if (sistemasData.length < 2) return; 

            const newIndex = paginaAtual + direcao;

            if (newIndex < 0 || newIndex >= sistemasData.length) return;

            salvarDadosSistema(paginaAtual);

            [sistemasData[paginaAtual], sistemasData[newIndex]] = [sistemasData[newIndex], sistemasData[paginaAtual]];

            paginaAtual = newIndex;

            renderizarPaginacao();
            renderizarSistema(paginaAtual);
        }

		function removerUltimoSistema() {
			if (sistemasData.length === 0) return; 

			const sistemaIndex = paginaAtual; 
			const sistemaRemover = sistemasData[sistemaIndex];
			const tituloCapitulo = sistemaRemover.sistema || `Capítulo ${sistemaIndex + 1}`;

			const confirmModal = document.getElementById('confirm-modal');
			const confirmMessage = document.getElementById('confirm-modal-message');
			const confirmYesBtn = document.getElementById('confirm-modal-yes');
			const confirmNoBtn = document.getElementById('confirm-modal-no');

			confirmMessage.innerHTML = `Deseja excluir o capítulo Nº ${sistemaIndex + 1} (${tituloCapitulo})?`;
			confirmModal.style.display = 'flex'; 

			confirmYesBtn.onclick = null;
			confirmNoBtn.onclick = null;

			confirmYesBtn.onclick = () => {
				confirmModal.style.display = 'none'; 

				sistemasData.splice(sistemaIndex, 1); 

				if (sistemasData.length > 0) {
					paginaAtual = Math.min(sistemaIndex, sistemasData.length - 1); 
					renderizarPaginacao();
					renderizarSistema(paginaAtual);
				} else {
					document.getElementById('sistemas-container').innerHTML = '';
					document.getElementById('paginas-navegacao').innerHTML = '';
					paginaAtual = 0;
				}
			};

			confirmNoBtn.onclick = () => {
				confirmModal.style.display = 'none'; 
			};
		}

		function mostrarPagina(index) {
			if (index >= 0 && index < sistemasData.length) {
				if (paginaAtual !== undefined && paginaAtual >= 0) salvarDadosSistema(paginaAtual);
				paginaAtual = index;
				renderizarPaginacao();
				renderizarSistema(paginaAtual);
			}
		}

		function renderizarPaginacao() {
			const paginacaoDiv = document.getElementById("paginas-navegacao");
			paginacaoDiv.innerHTML = "";
			sistemasData.forEach((_, index) => {
				const btn = document.createElement("button");
				btn.type = "button";
				btn.innerText = index + 1;
				btn.onclick = () => {
					salvarDadosSistema(paginaAtual);
					paginaAtual = index;
					renderizarSistema(paginaAtual);
					renderizarPaginacao();
				};
				btn.classList.add("btn-paginacao");
				const tituloCap = sistemasData[index]?.sistema;
				btn.title = tituloCap ? `Capítulo: ${tituloCap}` : `Capítulo ${index + 1}`;
				if (index === paginaAtual) {
					btn.classList.add("active");
				}
				paginacaoDiv.appendChild(btn);
			});
		}

		function salvarDadosSistema(index) {
			if (index < 0 || index >= sistemasData.length) return;
            
			const systemDiv = document.querySelector(`#sistemas-container .system-block`);
			if (!systemDiv) return;

			const selectElement = systemDiv.querySelector(`select[name="sistema_${index}"]`);
			if (!selectElement) return;

			const outroInputEl = systemDiv.querySelector(`input[name="sistema_outro_${index}"]`);
			const sistemaValor = selectElement.value === 'Outro' ? (outroInputEl ? outroInputEl.value : '') : selectElement.value;
			const transferenciaValue = systemDiv.querySelector(`input[name="transferencia_${index}"]:checked`)?.value;

			const getVal = (sel) => systemDiv.querySelector(sel)?.value || '';
			const getHtml = (sel) => systemDiv.querySelector(sel)?.innerHTML || '';
            
            const caixasExistentes = sistemasData[index].caixas;
            const paginasExistentes = sistemasData[index].paginas;

			sistemasData[index] = {
                caixas: caixasExistentes,
                paginas: paginasExistentes,
				sistema: sistemaValor,
				transferencia: transferenciaValue,
				idtransf: getVal(`#idtransf_${index}`),
				paginasprev: getVal(`input[name="paginasprev_${index}"]`),
				modulo: getVal(`input[name="modulo_${index}"]`),
				nomematerial: getVal(`input[name="nomematerial_${index}"]`),
				codmodulo: getHtml(`#codmodulo_${index}`),
				codconectores: getVal(`textarea[name="codconectores_${index}"]`),
				pagloc: getHtml(`#pagloc_${index}`),
				pagcon: getHtml(`#pagcon_${index}`),
				pagdiag: getHtml(`#pagdiag_${index}`)
			};
			
			renderizarPaginacao();
		}

		// Funções para a aba "Veículos Aplicáveis"
		function renderizarPaginacaoVeiculosAplicaveis() {
			const paginacaoDiv = document.getElementById("paginacao-veiculos-aplicaveis");
			paginacaoDiv.innerHTML = "";
			veiculosAplicaveisData.forEach((_, index) => {
				const btn = document.createElement("button");
				btn.type = "button";
				btn.innerText = index + 1;
				btn.onclick = () => mostrarPaginaVeiculoAplicavel(index);
				const veiculoRef = veiculosAplicaveisData[index]?.dadosGerais?.veiculo;
				btn.title = extrairTooltipVeiculo(veiculoRef) || `Veículo ${index + 1}`;
				btn.classList.add("btn-paginacao");
				if (index === veiculoAplicavelAtual) {
					btn.classList.add("active");
				}
				paginacaoDiv.appendChild(btn);
			});
		}

		function mostrarPaginaVeiculoAplicavel(index) {
			if (index >= 0 && index < veiculosAplicaveisData.length) {
				if(veiculosAplicaveisData.length > 0 && veiculoAplicavelAtual >= 0) {
					salvarDadosVeiculoAplicavel(veiculoAplicavelAtual);
				}
				veiculoAplicavelAtual = index;
				renderizarVeiculoAplicavel(veiculoAplicavelAtual);
				renderizarPaginacaoVeiculosAplicaveis();
			}
		}

		function criarNovoVeiculoAplicavel() {
			veiculosAplicaveisData.push({
				dadosGerais: {},
				itensSerie: {},
				sistemas: []
			});
			veiculoAplicavelAtual = veiculosAplicaveisData.length - 1;
			renderizarVeiculoAplicavel(veiculoAplicavelAtual);
			renderizarPaginacaoVeiculosAplicaveis();
		}

		function adicionarVeiculoAplicavel() {
			if (veiculosAplicaveisData.length > 0) {
				salvarDadosVeiculoAplicavel(veiculoAplicavelAtual);
			}
			criarNovoVeiculoAplicavel();
			atualizarVisibilidadeDadosCardAplicaveis();
		}

		function removerUltimoVeiculoAplicavel() {
			if (veiculosAplicaveisData.length === 0) return; 

			const veiculoIndex = veiculoAplicavelAtual; 
			const veiculoRemover = veiculosAplicaveisData[veiculoIndex];
			const tituloVeiculo = extrairTooltipVeiculo(veiculoRemover.dadosGerais.veiculo) || `Veículo ${veiculoIndex + 1}`;

			const confirmModal = document.getElementById('confirm-modal');
			const confirmMessage = document.getElementById('confirm-modal-message');
			const confirmYesBtn = document.getElementById('confirm-modal-yes');
			const confirmNoBtn = document.getElementById('confirm-modal-no');

			confirmMessage.innerHTML = `Deseja excluir o Veículo Aplicável Nº ${veiculoIndex + 1} (${tituloVeiculo})?`;
			confirmModal.style.display = 'flex'; 

			confirmYesBtn.onclick = null;
			confirmNoBtn.onclick = null;

			confirmYesBtn.onclick = () => {
				confirmModal.style.display = 'none'; 

				veiculosAplicaveisData.splice(veiculoIndex, 1); 

				if (veiculosAplicaveisData.length > 0) {
					veiculoAplicavelAtual = Math.min(veiculoIndex, veiculosAplicaveisData.length - 1);
					renderizarVeiculoAplicavel(veiculoAplicavelAtual);
					renderizarPaginacaoVeiculosAplicaveis();
				} else {
					document.getElementById('veiculos-aplicaveis-container').innerHTML = '';
					document.getElementById('paginacao-veiculos-aplicaveis').innerHTML = '';
					veiculoAplicavelAtual = 0;
				}
				atualizarVisibilidadeDadosCardAplicaveis();
			};

			confirmNoBtn.onclick = () => {
				confirmModal.style.display = 'none';
			};
		}

		function renderizarVeiculoAplicavel(veiculoIndex) {
			const container = document.getElementById("veiculos-aplicaveis-container");
			container.innerHTML = "";
			if(veiculoIndex < 0 || veiculoIndex >= veiculosAplicaveisData.length) return;
			const veiculo = veiculosAplicaveisData[veiculoIndex];

			const formHtml = `
				<div class="veiculo-aplicavel-block">
					<fieldset>
						<legend>INFORMAÇÕES GERAIS (Veículo ${veiculoIndex + 1})</legend>
						<label for="veiculo_aplicaveis_${veiculoIndex}">Veículo Referência</label>
						<input type="text" id="veiculo_aplicaveis_${veiculoIndex}" value="${veiculo.dadosGerais.veiculo || ''}" placeholder="Car>1994>Mazda>RX-7>1.3 256cv (13B - Wankel)" onchange="salvarDadosVeiculoAplicavel(${veiculoIndex})">
						<div class="id-fields-container">
							<div class="field-group">
								<label for="iddiagramas_aplicaveis_${veiculoIndex}">ID DIAGRAMAS</label>
								<input type="number" id="iddiagramas_aplicaveis_${veiculoIndex}" value="${veiculo.dadosGerais.iddiagramas || ''}" placeholder="Apenas números" onchange="salvarDadosVeiculoAplicavel(${veiculoIndex})">
							</div>
							<div class="field-group">
								<label for="idfusiveis_aplicaveis_${veiculoIndex}">ID FUSÍVEIS</label>
								<input type="number" id="idfusiveis_aplicaveis_${veiculoIndex}" value="${veiculo.dadosGerais.idfusiveis || ''}" placeholder="Apenas números" onchange="salvarDadosVeiculoAplicavel(${veiculoIndex})">
							</div>
						</div>
						<label for="pasta_aplicaveis_${veiculoIndex}">PASTA DO VEÍCULO</label>
						<input type="text" id="pasta_aplicaveis_${veiculoIndex}" value="${veiculo.dadosGerais.pasta || ''}" placeholder="P:\\Desenvolvimento\\+ DIAGRAMAS..." onchange="salvarDadosVeiculoAplicavel(${veiculoIndex})">
						<div class="checkbox-block">
							<label class="checkbox-title">PESQUISA (VEÍCULO PRINCIPAL OU SEMELHANTE)</label>
							<div class="checkbox-inline" onchange="togglePesquisaTexto('aplicavel', ${veiculoIndex}); salvarDadosVeiculoAplicavel(${veiculoIndex})">
								<label><input type="radio" name="pesquisa_aplicaveis_${veiculoIndex}" value="sim" ${veiculo.dadosGerais.pesquisa === 'sim' ? 'checked' : ''}> SIM</label>
								<label><input type="radio" name="pesquisa_aplicaveis_${veiculoIndex}" value="nao" ${veiculo.dadosGerais.pesquisa !== 'sim' ? 'checked' : ''}> NÃO</label>
							</div>
						</div>
						<textarea id="pesquisa_texto_aplicaveis_${veiculoIndex}" rows="3" placeholder="I:\\INFORMAÇÕES\\Mazda\\Pesquisa\\RX-7..." style="display: ${veiculo.dadosGerais.pesquisa === 'sim' ? 'block' : 'none'}; min-height: auto;" onchange="salvarDadosVeiculoAplicavel(${veiculoIndex})">${veiculo.dadosGerais.pesquisa_texto || ''}</textarea>
						
						<div class="checkbox-blockk"></div>
						
						<label for="comentarios_aplicaveis_${veiculoIndex}">IMPORTANTE PARA O DESENVOLVIMENTO</label>
						<div class="development-field-container">
							<div contenteditable="true" class="editable-content" id="comentarios_aplicaveis_${veiculoIndex}" data-field="comentarios_aplicaveis" oninput="salvarDadosVeiculoAplicavel(${veiculoIndex})" data-placeholder="Descreva tudo que influenciará no desenvolvimento dos manuais...">${veiculo.dadosGerais.comentarios || ''}</div>
							<button type="button" class="btn-anexar" onclick="abrirSeletorArquivo('comentarios_aplicaveis_${veiculoIndex}')">Anexar</button>
							<input type="file" id="file_comentarios_aplicaveis_${veiculoIndex}" class="file-input-hidden" multiple accept="image/*,.pdf,.doc,.docx,.txt,.csv,.xls,.xlsx,.ppt,.pptx" onchange="processarArquivosSelecionados('comentarios_aplicaveis_${veiculoIndex}', this.files)">
						</div>
						<div class="checkbox-block">
						</div>
						
						<div class="checkbox-blockk"></div>
						
						<label>APLICAÇÃO / CHASSI</label>
						<div class="checkbox-inline" style="margin-bottom: 10px;" onchange="salvarDadosVeiculoAplicavel(${veiculoIndex})">
							<label><input type="radio" name="aplicacao_chassi_aplicaveis_${veiculoIndex}" value="mesma" ${veiculo.dadosGerais.aplicacao_chassi === 'mesma' ? 'checked' : ''}> Mesma aplicação</label>
							<label><input type="radio" name="aplicacao_chassi_aplicaveis_${veiculoIndex}" value="ajustar" ${veiculo.dadosGerais.aplicacao_chassi === 'ajustar' ? 'checked' : ''}> Ajustar aplicação</label>
						</div>
						<textarea id="aplicacao_chassi_texto_aplicaveis_${veiculoIndex}" rows="3" placeholder="Insira aqui a aplicação e chassis do veículo." style="min-height: auto;" onchange="salvarDadosVeiculoAplicavel(${veiculoIndex})">${veiculo.dadosGerais.aplicacao_chassi_texto || ''}</textarea>
						
						<div style="margin-bottom: 10px; display: flex; flex-wrap: wrap; justify-content: left;">
							<button type="button" class="orange-button" onclick="window.open('http://192.168.201.220:4000/', '_blank')" style="margin-top: 5px;">Buscar chassi</button>
						</div>
						<div class="checkbox-blockk"></div>
						
						<label for="ilustracao_texto_aplicaveis_${veiculoIndex}">PEDIDOS DE ILUSTRAÇÃO / TRATAMENTO DE IMAGEM</label>
						<textarea id="ilustracao_texto_aplicaveis_${veiculoIndex}" rows="3" style="min-height: auto;" onchange="salvarDadosVeiculoAplicavel(${veiculoIndex})" placeholder="P:\\Desenvolvimento\\+ DIAGRAMAS\\0. (2026-X)\\Mazda\\RX-7>1.3 256cv (13B - Wankel) (1994)\\Fotos e Ilustrações\\Pedidos...">${veiculo.dadosGerais.ilustracao_texto || ''}</textarea>
					</fieldset>

					<fieldset>
						<legend>ITENS DE SÉRIE / OPCIONAIS (Veículo ${veiculoIndex + 1})</legend>
						
						<!-- CHAVE / BOTÃO / ENCAIXE -->
						<div class="checkbox-block">
						  <label class="checkbox-title">TIPO DE CHAVE:</label>
						  <div class="checkbox-inline" onchange="salvarDadosVeiculoAplicavel(${veiculoIndex})">
							<label><input type="checkbox" name="chave_aplicaveis_${veiculoIndex}" value="Comum" ${(veiculo.itensSerie.chave || []).includes('Comum') ? 'checked' : ''}> COMUM</label>
							<label><input type="checkbox" name="chave_aplicaveis_${veiculoIndex}" value="Presencial (Botão)" ${(veiculo.itensSerie.chave || []).includes('Presencial (Botão)') ? 'checked' : ''}> PRESENCIAL (BOTÃO)</label>
							<label><input type="checkbox" name="chave_aplicaveis_${veiculoIndex}" value="Encaixe Inteligente" ${(veiculo.itensSerie.chave || []).includes('Encaixe Inteligente') ? 'checked' : ''}> ENCAIXE INTELIGENTE</label>
						  </div>
						</div>

						<div class="checkbox-blockk"></div>

						<!-- FUNÇÃO START/STOP -->
						<div class="checkbox-block">
						  <label class="checkbox-title">FUNÇÃO START/STOP:</label>
						  <div class="checkbox-inline" onchange="salvarDadosVeiculoAplicavel(${veiculoIndex})">
							<label><input type="radio" name="startstop_aplicaveis_${veiculoIndex}" value="sim_serie" ${veiculo.itensSerie.startstop === 'sim_serie' ? 'checked' : ''}> SIM (DE SÉRIE)</label>
							<label><input type="radio" name="startstop_aplicaveis_${veiculoIndex}" value="sim_opcional" ${veiculo.itensSerie.startstop === 'sim_opcional' ? 'checked' : ''}> SIM (OPCIONAL)</label>
							<label><input type="radio" name="startstop_aplicaveis_${veiculoIndex}" value="nao" ${veiculo.itensSerie.startstop === 'nao' ? 'checked' : ''}> NÃO</label>
						  </div>
						</div>

						<div class="checkbox-blockk"></div>

						<!-- AR-CONDICIONADO -->
						<div class="checkbox-block">
						  <label class="checkbox-title">AR-CONDICIONADO:</label>
						  <div class="checkbox-inline" onchange="salvarDadosVeiculoAplicavel(${veiculoIndex})">
							<label><input type="checkbox" name="ac_aplicaveis_${veiculoIndex}" value="Manual" ${(veiculo.itensSerie.ac || []).includes('Manual') ? 'checked' : ''}> MANUAL</label>
							<label><input type="checkbox" name="ac_aplicaveis_${veiculoIndex}" value="Automático" ${(veiculo.itensSerie.ac || []).includes('Automático') ? 'checked' : ''}> AUTOMÁTICO</label>
							<label><input type="checkbox" name="ac_aplicaveis_${veiculoIndex}" value="Só Ar Quente" ${(veiculo.itensSerie.ac || []).includes('Só Ar Quente') ? 'checked' : ''}> SÓ AR QUENTE</label>
						  </div>
						</div>

						<div class="checkbox-blockk"></div>
						
						<!-- TRANSMISSÃO -->
						<div class="checkbox-block">
						  <label class="checkbox-title">TRANSMISSÃO:</label>
						  <div class="checkbox-inline" onchange="salvarDadosVeiculoAplicavel(${veiculoIndex})">
							<label><input type="checkbox" name="atmt_aplicaveis_${veiculoIndex}" value="AT" ${(veiculo.itensSerie.atmt || []).includes('AT') ? 'checked' : ''}> AT</label>
							<label><input type="checkbox" name="atmt_aplicaveis_${veiculoIndex}" value="MT" ${(veiculo.itensSerie.atmt || []).includes('MT') ? 'checked' : ''}> MT</label>
						  </div>
						</div>

						<div class="checkbox-blockk"></div>
						
						<!-- TRAÇÃO -->
						<div class="checkbox-block">
							<label class="checkbox-title">TRAÇÃO:</label>
							<div class="checkbox-inline" onchange="salvarDadosVeiculoAplicavel(${veiculoIndex})">
								<label><input type="checkbox" name="tracao_aplicaveis_${veiculoIndex}" value="4X2" ${(veiculo.itensSerie.tracao || []).includes('4X2') ? 'checked' : ''}> 4X2</label>
								<label><input type="checkbox" name="tracao_aplicaveis_${veiculoIndex}" value="4X4" ${(veiculo.itensSerie.tracao || []).includes('4X4') ? 'checked' : ''}> 4X4</label>
								<label><input type="checkbox" name="tracao_aplicaveis_${veiculoIndex}" value="6X2" ${(veiculo.itensSerie.tracao || []).includes('6X2') ? 'checked' : ''}> 6X2</label>
								<label><input type="checkbox" name="tracao_aplicaveis_${veiculoIndex}" value="6X4" ${(veiculo.itensSerie.tracao || []).includes('6X4') ? 'checked' : ''}> 6X4</label>
								<label><input type="checkbox" name="tracao_aplicaveis_${veiculoIndex}" value="8X2" ${(veiculo.itensSerie.tracao || []).includes('8X2') ? 'checked' : ''}> 8X2</label>
								<label><input type="checkbox" name="tracao_aplicaveis_${veiculoIndex}" value="8X4" ${(veiculo.itensSerie.tracao || []).includes('8X4') ? 'checked' : ''}> 8X4</label>
								<label><input type="checkbox" name="tracao_aplicaveis_${veiculoIndex}" value="8X8" ${(veiculo.itensSerie.tracao || []).includes('8X8') ? 'checked' : ''}> 8X8</label>
							</div>
						</div>
						<div class="checkbox-blockk"></div>
						
						<!-- ADAS -->
						<div class="checkbox-block">
							<label class="checkbox-title">ADAS:</label>
							<div class="checkbox-inline" onchange="toggleAdasTexto('aplicavel', ${veiculoIndex}); salvarDadosVeiculoAplicavel(${veiculoIndex})">
								<label><input type="radio" name="adas_aplicaveis_${veiculoIndex}" value="sim_serie" ${veiculo.itensSerie.adas === 'sim_serie' ? 'checked' : ''}> SIM (DE SÉRIE)</label>
								<label><input type="radio" name="adas_aplicaveis_${veiculoIndex}" value="sim_opcional" ${veiculo.itensSerie.adas === 'sim_opcional' ? 'checked' : ''}> SIM (OPCIONAL)</label>
								<label><input type="radio" name="adas_aplicaveis_${veiculoIndex}" value="nao" ${veiculo.itensSerie.adas === 'nao' ? 'checked' : ''}> NÃO</label>
							</div>
						</div>
						<textarea id="adas_texto_aplicaveis_${veiculoIndex}" rows="3" placeholder="Especifique..." style="display: ${veiculo.itensSerie.adas === 'sim_serie' || veiculo.itensSerie.adas === 'sim_opcional' ? 'block' : 'none'}; min-height: auto;" onchange="salvarDadosVeiculoAplicavel(${veiculoIndex})">${veiculo.itensSerie.adas_texto || ''}</textarea>
						
						<div class="checkbox-blockk"></div>
						
						<!-- EXTRAS -->
						<label for="extras_aplicaveis_${veiculoIndex}">EXTRAS:</label>
						<textarea id="extras_aplicaveis_${veiculoIndex}" rows="3" placeholder="Teto solar, faróis de xenônio, Rádio e Multimídia, etc..." onchange="salvarDadosVeiculoAplicavel(${veiculoIndex})">${veiculo.itensSerie.extras || ''}</textarea>
					</fieldset>

					<fieldset>
						<legend>SISTEMAS (Veículo ${veiculoIndex + 1})</legend>
						<div id="sistemas-container-aplicaveis_${veiculoIndex}"></div>
						<div id="paginas-navegacao-aplicaveis_${veiculoIndex}" class="paginas-navegacao"></div>
						<div style="display: flex; gap: 10px; justify-content: center; margin: 10px 0;">
							<button type="button" class="orange-button" onclick="moverSistemaAplicavel(${veiculoIndex}, -1)" title="Mover capítulo para a esquerda">←</button>
							<button type="button" class="orange-button" onclick="moverSistemaAplicavel(${veiculoIndex}, 1)" title="Mover capítulo para a direita">→</button>
						</div>
						<div class="button-group-centered">
							<button class="orange-button" onclick="adicionarSistemaAplicaveis(${veiculoIndex})">➕ Adicionar Capítulo</button>
							<button class="orange-button" onclick="removerUltimoSistemaAplicaveis(${veiculoIndex})">➖ Remover Capítulo Selecionado</button>
							<button type="button" class="orange-button" onclick="abrirModalCopia(${veiculoIndex})">Copiar Capítulo</button>
						</div>
					</fieldset>
				</div>
			`;
			container.innerHTML = formHtml;

			atualizarVisibilidadeDadosCardAplicaveis();

			if (veiculo.sistemas.length > 0) {
				renderizarPaginacaoAplicaveis(veiculoIndex);
				renderizarSistemaAplicaveis(veiculoIndex, veiculo.paginaAtual || 0);
			}

			setupDragAndDrop(`comentarios_aplicaveis_${veiculoIndex}`);
			setupEditableContent(`comentarios_aplicaveis_${veiculoIndex}`);
		}

		function getCaretPosition(element) {
			const selection = window.getSelection();
			if (selection.rangeCount > 0) {
				const range = selection.getRangeAt(0);
				if (element.contains(range.commonAncestorContainer)) {
					return range;
				}
			}
			return null;
		}

		function insertAtCursor(element, content) {
			const selection = window.getSelection();
			const range = getCaretPosition(element);
			
			if (range) {
				range.deleteContents();
				range.insertNode(content);
				range.collapse(false);
				selection.removeAllRanges();
				selection.addRange(range);
			} else {
				element.appendChild(content);
			}
		}

		function criarMiniatura(dataUrl, maxWidth = 150, maxHeight = 100) {
			return new Promise((resolve) => {
				const img = new Image();
				img.onload = () => {
					const canvas = document.createElement('canvas');
					const ctx = canvas.getContext('2d');
					
					let { width, height } = img;
					if (width > maxWidth) {
						height = (height * maxWidth) / width;
						width = maxWidth;
					}
					if (height > maxHeight) {
						width = (width * maxHeight) / height;
						height = maxHeight;
					}
					
					canvas.width = width;
					canvas.height = height;
					
					ctx.drawImage(img, 0, 0, width, height);
					
					const thumbnailDataUrl = canvas.toDataURL('image/jpeg', 0.8);
					resolve(thumbnailDataUrl);
				};
				img.src = dataUrl;
			});
		}

		async function processarArquivo(element, file) {
			const reader = new FileReader();
			reader.onload = async (readerEvent) => {
				const dataUrl = readerEvent.target.result;
				let content;
				
				if (file.type && file.type.startsWith('image/')) {
					const thumbnailDataUrl = await criarMiniatura(dataUrl);
					
					const imgContainer = document.createElement('div');
					imgContainer.className = 'image-container';
					imgContainer.style.display = 'inline-block';
					imgContainer.style.marginTop = '5px';
					imgContainer.style.marginBottom = '5px';
					
					const img = document.createElement('img');
					img.src = thumbnailDataUrl;
					img.style.maxWidth = '150px';
					img.style.maxHeight = '100px';
					img.style.display = 'block';
					img.style.border = '1px solid #ccc';
					img.style.borderRadius = '4px';
					img.style.cursor = 'pointer';
					img.title = `Clique para ver em tamanho real: ${file.name}`;
					
					img.setAttribute('data-original-image', dataUrl);
					img.setAttribute('data-filename', file.name || 'imagem');
					img.setAttribute('data-mime', file.type);
					
					img.addEventListener('click', () => {
						const modal = document.createElement('div');
						modal.style.position = 'fixed';
						modal.style.top = '0';
						modal.style.left = '0';
						modal.style.width = '100%';
						modal.style.height = '100%';
						modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
						modal.style.display = 'flex';
						modal.style.justifyContent = 'center';
						modal.style.alignItems = 'center';
						modal.style.zIndex = '10000';
						modal.style.cursor = 'pointer';
						
						const modalImg = document.createElement('img');
						modalImg.src = dataUrl;
						modalImg.style.maxWidth = '90%';
						modalImg.style.maxHeight = '90%';
						modalImg.style.objectFit = 'contain';
						
						modal.appendChild(modalImg);
						document.body.appendChild(modal);
						
						modal.addEventListener('click', () => {
							document.body.removeChild(modal);
						});
					});
					
					imgContainer.appendChild(img);
					content = imgContainer;
				} else {
					const link = document.createElement('a');
					link.href = dataUrl;
					link.target = '_blank';
					link.download = file.name || 'anexo';
					link.textContent = file.name || 'anexo';
					link.style.display = 'inline-block';
					link.style.marginTop = '5px';
					link.className = 'attachment';
					link.setAttribute('data-filename', file.name || 'anexo');
					if (file.type) link.setAttribute('data-mime', file.type);
					link.contentEditable = 'false';
					content = link;
				}
				
				insertAtCursor(element, content);
				
				const br = document.createElement('br');
				insertAtCursor(element, br);
				
				if (element.oninput) {
					element.oninput();
				}
			};
			reader.readAsDataURL(file);
		}

		function setupDragAndDrop(elementId) {
			const element = document.getElementById(elementId);
			if (!element) return;

			element.addEventListener('dragover', (e) => {
				e.preventDefault();
				e.stopPropagation();
				element.classList.add('drag-over');
			});

			element.addEventListener('dragleave', (e) => {
				e.stopPropagation();
				element.classList.remove('drag-over');
			});

			element.addEventListener('drop', (e) => {
				e.preventDefault();
				e.stopPropagation();
				element.classList.remove('drag-over');

				const files = e.dataTransfer.files;
				if (files && files.length > 0) {
					for (let i = 0; i < files.length; i++) {
						processarArquivo(element, files[i]);
					}
				}
			});
		}

		function abrirSeletorArquivo(elementId) {
			const fileInput = document.getElementById(`file_${elementId}`);
			if (fileInput) {
				fileInput.click();
			}
		}

		function processarArquivosSelecionados(elementId, files) {
			const element = document.getElementById(elementId);
			if (!element || !files) return;
			
			element.focus();
			
			for (let i = 0; i < files.length; i++) {
				processarArquivo(element, files[i]);
			}
			
			const fileInput = document.getElementById(`file_${elementId}`);
			if (fileInput) {
				fileInput.value = '';
			}
		}

		function salvarDadosComentarios() {
		}

		function updateEditablePlaceholder(element) {
			if (!element) return;
			
			const hasContent = element.innerHTML.trim() !== '';
			if (hasContent) {
				element.classList.remove('empty');
			} else {
				element.classList.add('empty');
			}
		}

		function autoResizeEditableContent(element) {
			if (!element) return;
			
			element.style.height = 'auto';
			
			const scrollHeight = element.scrollHeight;
			const minHeight = parseInt(window.getComputedStyle(element).minHeight, 10) || 120;
			const newHeight = Math.max(scrollHeight, minHeight);
			
			element.style.height = newHeight + 'px';
		}

		function getChapterFolderName(veiculo, sistema, capTitulo) {
			const sistemaIndex = sistema && veiculo.sistemas ? veiculo.sistemas.indexOf(sistema) + 1 : 1;
			return `Capítulo ${sistemaIndex} - ${capTitulo}`;
		}

		function salvarDadosVeiculoAplicavel(veiculoIndex) {
			if (veiculoIndex < 0 || veiculoIndex >= veiculosAplicaveisData.length) return;
			const veiculo = veiculosAplicaveisData[veiculoIndex];
			
			const getCheckedCheckboxValues = (name) => {
				const checkboxes = document.querySelectorAll(`input[name="${name}"]:checked`);
				return Array.from(checkboxes).map(cb => cb.value);
			};

			veiculo.dadosGerais = {
				veiculo: document.getElementById(`veiculo_aplicaveis_${veiculoIndex}`).value,
				iddiagramas: document.getElementById(`iddiagramas_aplicaveis_${veiculoIndex}`).value,
				idfusiveis: document.getElementById(`idfusiveis_aplicaveis_${veiculoIndex}`).value,
				pasta: document.getElementById(`pasta_aplicaveis_${veiculoIndex}`).value,
				pesquisa: document.querySelector(`input[name="pesquisa_aplicaveis_${veiculoIndex}"]:checked`)?.value,
				pesquisa_texto: document.getElementById(`pesquisa_texto_aplicaveis_${veiculoIndex}`).value,
				comentarios: document.getElementById(`comentarios_aplicaveis_${veiculoIndex}`).innerHTML,
				aplicacao_chassi: document.querySelector(`input[name="aplicacao_chassi_aplicaveis_${veiculoIndex}"]:checked`)?.value,
				aplicacao_chassi_texto: document.getElementById(`aplicacao_chassi_texto_aplicaveis_${veiculoIndex}`).value,
				ilustracao_texto: document.getElementById(`ilustracao_texto_aplicaveis_${veiculoIndex}`).value,
			};

			veiculo.itensSerie = {
			  atmt: getCheckedCheckboxValues(`atmt_aplicaveis_${veiculoIndex}`),
			  chave: getCheckedCheckboxValues(`chave_aplicaveis_${veiculoIndex}`),
			  startstop: document.querySelector(`input[name="startstop_aplicaveis_${veiculoIndex}"]:checked`)?.value,
			  ac: getCheckedCheckboxValues(`ac_aplicaveis_${veiculoIndex}`),
			  tracao: getCheckedCheckboxValues(`tracao_aplicaveis_${veiculoIndex}`),
			  adas: document.querySelector(`input[name="adas_aplicaveis_${veiculoIndex}"]:checked`)?.value,
			  adas_texto: document.getElementById(`adas_texto_aplicaveis_${veiculoIndex}`).value,
			  extras: document.getElementById(`extras_aplicaveis_${veiculoIndex}`).value
			};

			renderizarPaginacaoVeiculosAplicaveis();
		}

		function abrirModalCopia(veiculoIndex) {
			targetVeiculoIndexParaCopia = veiculoIndex;

			const selectVeiculo = document.getElementById('select-veiculo-copia');
			selectVeiculo.innerHTML = ''; // Limpa opções anteriores

			// Adiciona Veículo Principal
			const optPrincipal = document.createElement('option');
			optPrincipal.value = 'principal';
			optPrincipal.textContent = 'Veículo Principal';
			selectVeiculo.appendChild(optPrincipal);

			// Adiciona Veículos Aplicáveis
			veiculosAplicaveisData.forEach((veiculo, idx) => {
				const optAplicavel = document.createElement('option');
				optAplicavel.value = `aplicavel_${idx}`;
				const veiculoLabel = extrairTooltipVeiculo(veiculo.dadosGerais.veiculo) || `Veículo ${idx + 1}`;
				optAplicavel.textContent = `Veículo Aplicável ${idx + 1}: ${veiculoLabel}`;
				selectVeiculo.appendChild(optAplicavel);
			});

			popularCapitulosParaCopia(); // Popula os capítulos para o veículo inicialmente selecionado

			document.getElementById('copy-chapter-modal').style.display = 'flex';
		}

		function popularCapitulosParaCopia() {
			const selectVeiculo = document.getElementById('select-veiculo-copia');
			const selectCapitulo = document.getElementById('select-capitulo-copia');
			const selectedVeiculoValue = selectVeiculo.value;

			selectCapitulo.innerHTML = ''; // Limpa opções anteriores

			let sourceSistemas = [];

			if (selectedVeiculoValue === 'principal') {
				sourceSistemas = sistemasData;
			} else if (selectedVeiculoValue.startsWith('aplicavel_')) {
				const veiculoIndex = parseInt(selectedVeiculoValue.split('_')[1], 10);
				if (veiculosAplicaveisData[veiculoIndex]) {
					sourceSistemas = veiculosAplicaveisData[veiculoIndex].sistemas;
				}
			}

			if (sourceSistemas && sourceSistemas.length > 0) {
				sourceSistemas.forEach((sistema, idx) => {
					const optCapitulo = document.createElement('option');
					optCapitulo.value = idx;
					optCapitulo.textContent = `Capítulo ${idx + 1}: ${sistema.sistema || 'Sem título'}`;
					selectCapitulo.appendChild(optCapitulo);
				});
			} else {
				const optEmpty = document.createElement('option');
				optEmpty.textContent = 'Nenhum capítulo encontrado';
				optEmpty.disabled = true;
				selectCapitulo.appendChild(optEmpty);
			}
		}

		function executarCopiaCapitulo() {
			const selectVeiculo = document.getElementById('select-veiculo-copia');
			const selectCapitulo = document.getElementById('select-capitulo-copia');

			const selectedVeiculoValue = selectVeiculo.value;
			const selectedCapituloIndex = parseInt(selectCapitulo.value, 10);

			if (targetVeiculoIndexParaCopia === null || isNaN(selectedCapituloIndex)) {
				alert('Erro: Veículo de destino ou capítulo de origem inválido.');
				return;
			}

			let sourceSistemas = [];
			if (selectedVeiculoValue === 'principal') {
				sourceSistemas = sistemasData;
			} else if (selectedVeiculoValue.startsWith('aplicavel_')) {
				const veiculoIndex = parseInt(selectedVeiculoValue.split('_')[1], 10);
				sourceSistemas = veiculosAplicaveisData[veiculoIndex].sistemas;
			}

			const capituloParaCopiar = sourceSistemas[selectedCapituloIndex];

			if (capituloParaCopiar) {
				// Cópia profunda dos dados do capítulo
				const copiaCapitulo = JSON.parse(JSON.stringify(capituloParaCopiar));
				
				// Adiciona o capítulo copiado ao veículo de destino
				const veiculoDestino = veiculosAplicaveisData[targetVeiculoIndexParaCopia];
				veiculoDestino.sistemas.push(copiaCapitulo);

				// Atualiza a UI
				veiculoDestino.paginaAtual = veiculoDestino.sistemas.length - 1;
				renderizarPaginacaoAplicaveis(targetVeiculoIndexParaCopia);
				renderizarSistemaAplicaveis(targetVeiculoIndexParaCopia, veiculoDestino.paginaAtual);
			}

			// Fecha o modal
			document.getElementById('copy-chapter-modal').style.display = 'none';
			targetVeiculoIndexParaCopia = null; // Reseta o alvo
		}


		function renderizarSistemaAplicaveis(veiculoIndex, sistemaIndex) {
			const container = document.getElementById(`sistemas-container-aplicaveis_${veiculoIndex}`);
			container.innerHTML = "";
			const veiculo = veiculosAplicaveisData[veiculoIndex];
			if(!veiculo.sistemas || sistemaIndex < 0 || sistemaIndex >= veiculo.sistemas.length) return;
			const dados = veiculo.sistemas[sistemaIndex];

			if (!dados) return;

			const div = document.createElement("div");
			div.className = "system-block";
			div.innerHTML = `
				<label>Título do capítulo</label>
				<select name="sistema_aplicaveis_${veiculoIndex}_${sistemaIndex}" id="sistema_aplicaveis_${veiculoIndex}_${sistemaIndex}" onchange="salvarDadosSistemaAplicaveis(${veiculoIndex}, ${sistemaIndex}); renderizarFormularioCapituloAplicaveis(${veiculoIndex}, ${sistemaIndex});">
					<option value="">Selecione</option>
					<option value="Alimentação Positiva" ${dados.sistema === 'Alimentação Positiva' ? 'selected' : ''}>Alimentação Positiva</option>
					<option value="Conectores de Peito" ${dados.sistema === 'Conectores de Peito' ? 'selected' : ''}>Conectores de Peito</option>
					<option value="Fusíveis e Relés" ${dados.sistema === 'Fusíveis e Relés' ? 'selected' : ''}>Fusíveis e Relés</option>
					<option value="Central de Carroceria" ${dados.sistema === 'Central de Carroceria' ? 'selected' : ''}>Central de Carroceria</option>
					<option value="Airbag" ${dados.sistema === 'Airbag' ? 'selected' : ''}>Airbag</option>
					<option value="Ar-condicionado" ${dados.sistema === 'Ar-condicionado' ? 'selected' : ''}>Ar-condicionado</option>
					<option value="Freio ABS" ${dados.sistema === 'Freio ABS' ? 'selected' : ''}>Freio ABS</option>
					<option value="Freio de Estacionamento Eletrônico" ${dados.sistema === 'Freio de Estacionamento Eletrônico' ? 'selected' : ''}>Freio de Estacionamento Eletrônico</option>
					<option value="Painel de Instrumentos" ${dados.sistema === 'Painel de Instrumentos' ? 'selected' : ''}>Painel de Instrumentos</option>
					<option value="Injeção Eletrônica" ${dados.sistema === 'Injeção Eletrônica' ? 'selected' : ''}>Injeção Eletrônica</option>
					<option value="Injeção Eletrônica e Transmissão" ${dados.sistema === 'Injeção Eletrônica e Transmissão' ? 'selected' : ''}>Injeção Eletrônica e Transmissão</option>
					<option value="Sistema de Carga e Partida" ${dados.sistema === 'Sistema de Carga e Partida' ? 'selected' : ''}>Sistema de Carga e Partida</option>
					<option value="Transmissão Automática" ${dados.sistema === 'Transmissão Automática' ? 'selected' : ''}>Transmissão Automática</option>
					<option value="Tração 4x4" ${dados.sistema === 'Tração 4x4' ? 'selected' : ''}>Tração 4x4</option>
					<option value="Redes de Comunicação" ${dados.sistema === 'Redes de Comunicação' ? 'selected' : ''}>Redes de Comunicação</option>
					<option value="Rádio" ${dados.sistema === 'Rádio' ? 'selected' : ''}>Rádio</option>
					<option value="Central Multimídia" ${dados.sistema === 'Central Multimídia' ? 'selected' : ''}>Central Multimídia</option>
					<option value="Iluminação" ${dados.sistema === 'Iluminação' ? 'selected' : ''}>Iluminação</option>
					<option value="Outro" ${dados.sistema && !['Fusíveis e Relés', 'Alimentação Positiva', 'Conectores de Peito', 'Central de Carroceria', 'Injeção Eletrônica', 'Sistema de Carga e Partida', 'Injeção Eletrônica e Transmissão', 'Transmissão Automática', 'Tração 4x4', 'Redes de Comunicação', 'Painel de Instrumentos', 'Airbag', 'Ar-condicionado', 'Freio ABS', 'Freio de Estacionamento Eletrônico', 'Rádio', 'Central Multimídia', 'Iluminação'].includes(dados.sistema) ? 'selected' : ''}>Outro</option>
				</select>
				<div id="outrocampo_aplicaveis_${veiculoIndex}_${sistemaIndex}" style="display:none; margin-top: 5px;">
					<label>Especifique o título:</label>
					<input type="text" name="sistema_outro_aplicaveis_${veiculoIndex}_${sistemaIndex}" value="${dados.sistema && !['Fusíveis e Relés', 'Alimentação Positiva', 'Conectores de Peito', 'Central de Carroceria', 'Injeção Eletrônica', 'Sistema de Carga e Partida', 'Injeção Eletrônica e Transmissão', 'Transmissão Automática', 'Tração 4x4', 'Redes de Comunicação', 'Painel de Instrumentos', 'Airbag', 'Ar-condicionado', 'Freio ABS', 'Freio de Estacionamento Eletrônico', 'Rádio', 'Central Multimídia', 'Iluminação Interna e Externa'].includes(dados.sistema) ? dados.sistema : ''}" onchange="salvarDadosSistemaAplicaveis(${veiculoIndex}, ${sistemaIndex})">
				</div>
				<div id="formulario-capitulo-aplicaveis_${veiculoIndex}_${sistemaIndex}"></div>
			`;
			container.appendChild(div);

			const selectElement = div.querySelector(`select[name="sistema_aplicaveis_${veiculoIndex}_${sistemaIndex}"]`);
			const outroCampo = div.querySelector(`#outrocampo_aplicaveis_${veiculoIndex}_${sistemaIndex}`);
			const outroInput = div.querySelector(`input[name="sistema_outro_aplicaveis_${veiculoIndex}_${sistemaIndex}"]`);

			const toggleOutroCampo = () => {
				if (selectElement.value === 'Outro' || (selectElement.value === '' && outroInput.value !== '')) {
					outroCampo.style.display = 'block';
				} else {
					outroCampo.style.display = 'none';
				}
			};

			selectElement.addEventListener('change', toggleOutroCampo);
			toggleOutroCampo();
			
			if (dados.sistema) {
				renderizarFormularioCapituloAplicaveis(veiculoIndex, sistemaIndex);
			}
		}

		function toggleIdTransfAplicaveis(veiculoIndex, sistemaIndex) {
			const radio = document.querySelector(`input[name="transferencia_aplicaveis_${veiculoIndex}_${sistemaIndex}"]:checked`);
			const idTransfInput = document.getElementById(`idtransf_aplicaveis_${veiculoIndex}_${sistemaIndex}`);

			if (radio && idTransfInput) {
				idTransfInput.style.display = (radio.value === 'transferencia_outro') ? 'block' : 'none';
			}
		}

		function adicionarSistemaAplicaveis(veiculoIndex) {
			const veiculo = veiculosAplicaveisData[veiculoIndex];
			if (veiculo.sistemas.length > 0 && veiculo.paginaAtual >= 0) {
				salvarDadosSistemaAplicaveis(veiculoIndex, veiculo.paginaAtual);
			}
			veiculo.sistemas.push({});
			veiculo.paginaAtual = veiculo.sistemas.length - 1;
			renderizarPaginacaoAplicaveis(veiculoIndex);
			renderizarSistemaAplicaveis(veiculoIndex, veiculo.paginaAtual);
		}

		function moverSistemaAplicavel(veiculoIndex, direcao) {
            const veiculo = veiculosAplicaveisData[veiculoIndex];
            if (!veiculo || veiculo.sistemas.length < 2) return;

            const sistemaIndex = veiculo.paginaAtual;
            const newIndex = sistemaIndex + direcao;

            if (newIndex < 0 || newIndex >= veiculo.sistemas.length) return;

            salvarDadosSistemaAplicaveis(veiculoIndex, sistemaIndex);

            [veiculo.sistemas[sistemaIndex], veiculo.sistemas[newIndex]] = [veiculo.sistemas[newIndex], veiculo.sistemas[sistemaIndex]];

            veiculo.paginaAtual = newIndex;

            renderizarPaginacaoAplicaveis(veiculoIndex);
            renderizarSistemaAplicaveis(veiculoIndex, veiculo.paginaAtual);
        }

		function removerUltimoSistemaAplicaveis(veiculoIndex) {
			const veiculo = veiculosAplicaveisData[veiculoIndex];
			if (!veiculo || veiculo.sistemas.length === 0) return;

			const sistemaIndex = veiculo.paginaAtual; 
			const sistemaRemover = veiculo.sistemas[sistemaIndex];
			const tituloCapitulo = sistemaRemover.sistema || `Capítulo ${sistemaIndex + 1}`;

			const confirmModal = document.getElementById('confirm-modal');
			const confirmMessage = document.getElementById('confirm-modal-message');
			const confirmYesBtn = document.getElementById('confirm-modal-yes');
			const confirmNoBtn = document.getElementById('confirm-modal-no');

			confirmMessage.innerHTML = `Deseja excluir o capítulo Nº ${sistemaIndex + 1} (${tituloCapitulo}) do Veículo Aplicável ${veiculoIndex + 1}?`;
			confirmModal.style.display = 'flex'; 

			confirmYesBtn.onclick = null;
			confirmNoBtn.onclick = null;

			confirmYesBtn.onclick = () => {
				confirmModal.style.display = 'none'; 

				veiculo.sistemas.splice(sistemaIndex, 1); 

				if (veiculo.sistemas.length > 0) {
					veiculo.paginaAtual = Math.min(sistemaIndex, veiculo.sistemas.length - 1);
					renderizarPaginacaoAplicaveis(veiculoIndex);
					renderizarSistemaAplicaveis(veiculoIndex, veiculo.paginaAtual);
				} else {
					document.getElementById(`sistemas-container-aplicaveis_${veiculoIndex}`).innerHTML = '';
					document.getElementById(`paginas-navegacao-aplicaveis_${veiculoIndex}`).innerHTML = '';
					veiculo.paginaAtual = 0;
				}
			};

			confirmNoBtn.onclick = () => {
				confirmModal.style.display = 'none'; 
			};
		}

		function mostrarPaginaAplicaveis(veiculoIndex, sistemaIndex) {
			const veiculo = veiculosAplicaveisData[veiculoIndex];
			if (sistemaIndex >= 0 && sistemaIndex < veiculo.sistemas.length) {
				if (veiculo.paginaAtual !== undefined && veiculo.paginaAtual >= 0) {
					salvarDadosSistemaAplicaveis(veiculoIndex, veiculo.paginaAtual);
				}
				veiculo.paginaAtual = sistemaIndex;
				renderizarPaginacaoAplicaveis(veiculoIndex);
				renderizarSistemaAplicaveis(veiculoIndex, veiculo.paginaAtual);
			}
		}

		function renderizarPaginacaoAplicaveis(veiculoIndex) {
			const paginacaoDiv = document.getElementById(`paginas-navegacao-aplicaveis_${veiculoIndex}`);
			paginacaoDiv.innerHTML = "";
			const veiculo = veiculosAplicaveisData[veiculoIndex];
			veiculo.sistemas.forEach((_, index) => {
				const btn = document.createElement("button");
				btn.type = "button";
				btn.innerText = index + 1;
				btn.onclick = () => mostrarPaginaAplicaveis(veiculoIndex, index);
				btn.classList.add("btn-paginacao");
				const tituloCap = veiculo.sistemas[index]?.sistema;
				btn.title = tituloCap ? `Capítulo: ${tituloCap}` : `Capítulo ${index + 1}`;
				if (index === veiculo.paginaAtual) {
					btn.classList.add("active");
				}
				paginacaoDiv.appendChild(btn);
			});
		}

		function salvarDadosSistemaAplicaveis(veiculoIndex, sistemaIndex) {
			const veiculo = veiculosAplicaveisData[veiculoIndex];
			if (!veiculo || !veiculo.sistemas[sistemaIndex]) return;

			const systemDiv = document.querySelector(`#sistemas-container-aplicaveis_${veiculoIndex} .system-block`);
			if (!systemDiv) return;

			const selectElement = systemDiv.querySelector(`select[name="sistema_aplicaveis_${veiculoIndex}_${sistemaIndex}"]`);
			const sistemaValor = selectElement.value === 'Outro' 
				? systemDiv.querySelector(`input[name="sistema_outro_aplicaveis_${veiculoIndex}_${sistemaIndex}"]`)?.value 
				: selectElement.value;
			
			const transferenciaValue = systemDiv.querySelector(`input[name="transferencia_aplicaveis_${veiculoIndex}_${sistemaIndex}"]:checked`)?.value;

			const getIdTransfAplicaveisValue = () => {
				const element = document.getElementById(`idtransf_aplicaveis_${veiculoIndex}_${sistemaIndex}`);
				return element ? element.value : '';
			};

			const getVal = (sel) => systemDiv.querySelector(sel)?.value || '';
			const getHtml = (sel) => systemDiv.querySelector(sel)?.innerHTML || '';

			const caixasExistentes = veiculo.sistemas[sistemaIndex].caixas;
			const paginasExistentes = veiculo.sistemas[sistemaIndex].paginas;

			veiculo.sistemas[sistemaIndex] = {
				caixas: caixasExistentes,
                paginas: paginasExistentes,
				sistema: sistemaValor,
				transferencia: transferenciaValue,
				idtransf: getIdTransfAplicaveisValue(),
				paginasprev: getVal(`input[name="paginasprev_aplicaveis_${veiculoIndex}_${sistemaIndex}"]`),
				modulo: getVal(`input[name="modulo_aplicaveis_${veiculoIndex}_${sistemaIndex}"]`),
				nomematerial: getVal(`input[name="nomematerial_aplicaveis_${veiculoIndex}_${sistemaIndex}"]`),
				codmodulo: getHtml(`#codmodulo_aplicaveis_${veiculoIndex}_${sistemaIndex}`),
				codconectores: getVal(`textarea[name="codconectores_aplicaveis_${veiculoIndex}_${sistemaIndex}"]`),
				pagloc: getHtml(`#pagloc_aplicaveis_${veiculoIndex}_${sistemaIndex}`),
				pagcon: getHtml(`#pagcon_aplicaveis_${veiculoIndex}_${sistemaIndex}`),
				pagdiag: getHtml(`#pagdiag_aplicaveis_${veiculoIndex}_${sistemaIndex}`)
			};
			
			renderizarPaginacaoAplicaveis(veiculoIndex);
		}
        
        function adicionarCaixaAplicaveis(veiculoIndex, sistemaIndex) {
            const sistema = veiculosAplicaveisData[veiculoIndex].sistemas[sistemaIndex];
            if (!sistema.caixas) sistema.caixas = [];
            sistema.caixas.push({ nome: '', descricoes: '' });
            renderizarCaixasAplicaveis(veiculoIndex, sistemaIndex);
        }

        function removerCaixaAplicaveis(veiculoIndex, sistemaIndex, caixaIndex) {
            veiculosAplicaveisData[veiculoIndex].sistemas[sistemaIndex].caixas.splice(caixaIndex, 1);
            renderizarCaixasAplicaveis(veiculoIndex, sistemaIndex);
        }

        function moverCaixaAplicaveis(veiculoIndex, sistemaIndex, caixaIndex, direcao) {
            const caixas = veiculosAplicaveisData[veiculoIndex].sistemas[sistemaIndex].caixas;
            const newIndex = caixaIndex + direcao;
            if (newIndex < 0 || newIndex >= caixas.length) return;
            const itemMovido = caixas.splice(caixaIndex, 1)[0];
            caixas.splice(newIndex, 0, itemMovido);
            renderizarCaixasAplicaveis(veiculoIndex, sistemaIndex);
        }

        function renderizarCaixasAplicaveis(veiculoIndex, sistemaIndex) {
            const container = document.getElementById(`dynamic-content-container-aplicaveis_${veiculoIndex}_${sistemaIndex}`);
            if (!container) return;
            const caixas = veiculosAplicaveisData[veiculoIndex].sistemas[sistemaIndex].caixas || [];
            container.innerHTML = '';
            caixas.forEach((caixa, i) => {
                const descId = `descricoes_aplicaveis_${veiculoIndex}_${sistemaIndex}_${i}`;
                const caixaDiv = document.createElement('div');
                caixaDiv.className = 'caixa-item';
                caixaDiv.innerHTML = `
                    <label>Nome da Caixa</label>
                    <input type="text" value="${caixa.nome || ''}" oninput="veiculosAplicaveisData[${veiculoIndex}].sistemas[${sistemaIndex}].caixas[${i}].nome = this.value" placeholder="Ex: Caixa de Fusíveis do Painel">
                    <label>Descrições</label>
                    <div class="development-field-container">
                        <div contenteditable="true" class="editable-content" id="${descId}">${caixa.descricoes || ''}</div>
                        <div class="caixa-actions-column">
                            <button type="button" class="btn-anexar" onclick="abrirSeletorArquivo('${descId}')">Anexar</button>
                            <input type="file" id="file_${descId}" class="file-input-hidden" multiple onchange="processarArquivosSelecionados('${descId}', this.files)">
                            <button type="button" class="btn-remover-caixa" onclick="removerCaixaAplicaveis(${veiculoIndex}, ${sistemaIndex}, ${i})">- Remover</button>
                            <div class="mover-buttons">
                                <button type="button" class="btn-mover-caixa" onclick="moverCaixaAplicaveis(${veiculoIndex}, ${sistemaIndex}, ${i}, -1)">▲</button>
                                <button type="button" class="btn-mover-caixa" onclick="moverCaixaAplicaveis(${veiculoIndex}, ${sistemaIndex}, ${i}, 1)">▼</button>
                            </div>
                        </div>
                    </div>`;
                container.appendChild(caixaDiv);
                const descElement = document.getElementById(descId);
                descElement.oninput = () => { veiculosAplicaveisData[veiculoIndex].sistemas[sistemaIndex].caixas[i].descricoes = descElement.innerHTML; };
                setupDragAndDrop(descId);
                setupEditableContent(descId);
            });
        }

        function adicionarPaginaAplicaveis(veiculoIndex, sistemaIndex) {
            const sistema = veiculosAplicaveisData[veiculoIndex].sistemas[sistemaIndex];
            if (!sistema.paginas) sistema.paginas = [];
            sistema.paginas.push({ conteudo: '' });
            renderizarPaginasAplicaveis(veiculoIndex, sistemaIndex);
        }

        function removerPaginaAplicaveis(veiculoIndex, sistemaIndex, paginaIndex) {
            veiculosAplicaveisData[veiculoIndex].sistemas[sistemaIndex].paginas.splice(paginaIndex, 1);
            renderizarPaginasAplicaveis(veiculoIndex, sistemaIndex);
        }

        function moverPaginaAplicaveis(veiculoIndex, sistemaIndex, paginaIndex, direcao) {
            const paginas = veiculosAplicaveisData[veiculoIndex].sistemas[sistemaIndex].paginas;
            const newIndex = paginaIndex + direcao;
            if (newIndex < 0 || newIndex >= paginas.length) return;
            const itemMovido = paginas.splice(paginaIndex, 1)[0];
            paginas.splice(newIndex, 0, itemMovido);
            renderizarPaginasAplicaveis(veiculoIndex, sistemaIndex);
        }

        function renderizarPaginasAplicaveis(veiculoIndex, sistemaIndex) {
            const container = document.getElementById(`dynamic-content-container-aplicaveis_${veiculoIndex}_${sistemaIndex}`);
            if (!container) return;
            const paginas = veiculosAplicaveisData[veiculoIndex].sistemas[sistemaIndex].paginas || [];
            container.innerHTML = '';
            paginas.forEach((pagina, i) => {
                const descId = `descricoes_pagina_aplicaveis_${veiculoIndex}_${sistemaIndex}_${i}`;
                const paginaDiv = document.createElement('div');
                paginaDiv.className = 'caixa-item';
                paginaDiv.innerHTML = `
                    <label>Página ${i + 1}</label>
                    <div class="development-field-container">
                        <div contenteditable="true" class="editable-content" id="${descId}">${pagina.conteudo || ''}</div>
                        <div class="caixa-actions-column">
                            <button type="button" class="btn-anexar" onclick="abrirSeletorArquivo('${descId}')">Anexar</button>
                            <input type="file" id="file_${descId}" class="file-input-hidden" multiple onchange="processarArquivosSelecionados('${descId}', this.files)">
                            <button type="button" class="btn-remover-caixa" onclick="removerPaginaAplicaveis(${veiculoIndex}, ${sistemaIndex}, ${i})">- Remover</button>
                            <div class="mover-buttons">
                                <button type="button" class="btn-mover-caixa" onclick="moverPaginaAplicaveis(${veiculoIndex}, ${sistemaIndex}, ${i}, -1)">▲</button>
                                <button type="button" class="btn-mover-caixa" onclick="moverPaginaAplicaveis(${veiculoIndex}, ${sistemaIndex}, ${i}, 1)">▼</button>
                            </div>
                        </div>
                    </div>`;
                container.appendChild(paginaDiv);
                const descElement = document.getElementById(descId);
                descElement.oninput = () => { veiculosAplicaveisData[veiculoIndex].sistemas[sistemaIndex].paginas[i].conteudo = descElement.innerHTML; };
                setupDragAndDrop(descId);
                setupEditableContent(descId);
            });
        }


		function coletarDadosFormulario() {
			if (sistemasData.length > 0) {
				salvarDadosSistema(paginaAtual);
			}
			
			if (veiculosAplicaveisData.length > 0) {
				if (veiculosAplicaveisData[veiculoAplicavelAtual] && veiculosAplicaveisData[veiculoAplicavelAtual].sistemas.length > 0 && veiculosAplicaveisData[veiculoAplicavelAtual].paginaAtual >= 0) {
					salvarDadosSistemaAplicaveis(veiculoAplicavelAtual, veiculosAplicaveisData[veiculoAplicavelAtual].paginaAtual);
				}
				salvarDadosVeiculoAplicavel(veiculoAplicavelAtual);
			}

			const getCheckedCheckboxValues = (name) => {
				const checkboxes = document.querySelectorAll(`input[name="${name}"]:checked`);
				return Array.from(checkboxes).map(cb => cb.value);
			};

			const dataPrincipal = {
                planejado_por: document.getElementById("planejado_por").value,
				veiculo: document.getElementById("veiculo").value,
				clickup: document.getElementById("clickup").value,
				iddiagramas: document.getElementById("iddiagramas").value,
				idfusiveis: document.getElementById("idfusiveis").value,
				pasta: document.getElementById("pasta").value,
				pesquisa: document.querySelector('input[name="pesquisa"]:checked')?.value,
				pesquisa_texto: document.getElementById("pesquisa_texto").value,
				comentarios: document.getElementById("comentarios").innerHTML,
				aplicacao_chassi: document.querySelector('input[name="aplicacao_chassi"]:checked')?.value,
				aplicacao_chassi_texto: document.getElementById("aplicacao_chassi_texto").value,
				ilustracao_texto: document.getElementById("ilustracao_texto").value,
				atmt: getCheckedCheckboxValues('atmt'),
				chave: getCheckedCheckboxValues('chave'),
				startstop: document.querySelector('input[name="startstop"]:checked')?.value,
				ac: getCheckedCheckboxValues('ac'),
				tracao: getCheckedCheckboxValues("tracao"),
				adas: document.querySelector('input[name="adas"]:checked')?.value,
				adas_texto: document.getElementById("adas_texto").value,
				extras: document.getElementById("extras").value,
				dificuldade: document.getElementById("dificuldade").value,
				justificativa: document.getElementById("justificativa").value,
				dificuldade_aplicaveis: document.getElementById("dificuldade_aplicaveis").value,
				justificativa_aplicaveis: document.getElementById("justificativa_aplicaveis").value,
				sistemas: sistemasData
			};

			return {
				principal: dataPrincipal,
				aplicaveis: veiculosAplicaveisData
			};
		}



		function salvarComoJSON() {
			const data = coletarDadosFormulario();
			const dataStr = JSON.stringify(data, null, 2);
			const blob = new Blob([dataStr], { type: "application/json" });
			const url = URL.createObjectURL(blob);
			const a = document.createElement("a");
			a.href = url;
			let nomeArquivo = "planejamento.json";
			if (data.principal.veiculo && data.principal.veiculo.includes('>')) {
				const partes = data.principal.veiculo.split('>');
				if (partes.length >= 5) {
					const ano = partes[1].trim();
					const modelo = partes[3].trim();
					const motor = partes[4].trim();
					nomeArquivo = `Planejamento - ${ano} ${modelo} ${motor}.json`;
				}
			} else if (data.principal.veiculo) {
				nomeArquivo = `Planejamento - ${data.principal.veiculo}.json`;
			}
			a.download = nomeArquivo;
			document.body.appendChild(a);
			a.click();
			document.body.removeChild(a);
			URL.revokeObjectURL(url);
		}

		function carregarDeJSON(input) {
			const file = input.files[0];
			if (file) {
				const reader = new FileReader();
				reader.onload = function(e) {
					try {
						const dataJSON = JSON.parse(e.target.result);
						const dataPrincipal = dataJSON.principal || {};
						const dataAplicaveis = dataJSON.aplicaveis || [];

						const setData = (id, value) => {
							const element = document.getElementById(id);
							if (element) { element.value = value || ''; }
						};
						const setChecked = (name, value) => {
							const element = document.querySelector(`input[name="${name}"][value="${value}"]`);
							if (element) { element.checked = true; }
						};
						const setCheckedCheckboxes = (name, values) => {
							if (!Array.isArray(values)) return;
							const checkboxes = document.querySelectorAll(`input[name="${name}"]`);
							checkboxes.forEach(cb => {
								cb.checked = values.includes(cb.value);
							});
						};

						// Carrega dados da aba Principal
                        setData('planejado_por', dataPrincipal.planejado_por);
						setData('veiculo', dataPrincipal.veiculo);
						setData('clickup', dataPrincipal.clickup);
						setData('iddiagramas', dataPrincipal.iddiagramas);
						setData('idfusiveis', dataPrincipal.idfusiveis);
						setData('pasta', dataPrincipal.pasta);
						setData('pesquisa_texto', dataPrincipal.pesquisa_texto);
						setChecked('pesquisa', dataPrincipal.pesquisa);
						togglePesquisaTexto('principal', null);
						const comentariosElement = document.getElementById('comentarios');
						if (comentariosElement && dataPrincipal.comentarios) {
							comentariosElement.innerHTML = dataPrincipal.comentarios;
							updateEditablePlaceholder(comentariosElement);
						}
						setData('aplicacao_chassi_texto', dataPrincipal.aplicacao_chassi_texto);
						setChecked('aplicacao_chassi', dataPrincipal.aplicacao_chassi);
						setData('ilustracao_texto', dataPrincipal.ilustracao_texto);
						setCheckedCheckboxes('atmt', dataPrincipal.atmt);
						setCheckedCheckboxes('chave', dataPrincipal.chave);
						setChecked('startstop', dataPrincipal.startstop);
						setCheckedCheckboxes('ac', dataPrincipal.ac);
						setCheckedCheckboxes('tracao', dataPrincipal.tracao);
						setChecked('adas', dataPrincipal.adas);
						setData('adas_texto', dataPrincipal.adas_texto);
						toggleAdasTexto('principal', null);
						setData('extras', dataPrincipal.extras);
						setData('dificuldade', dataPrincipal.dificuldade);
						setData('justificativa', dataPrincipal.justificativa);
						sistemasData = dataPrincipal.sistemas || [];
						if (sistemasData.length > 0) {
							paginaAtual = 0;
							renderizarPaginacao();
							renderizarSistema(paginaAtual);
						} else {
							document.getElementById('sistemas-container').innerHTML = '';
							document.getElementById('paginas-navegacao').innerHTML = '';
						}

						// Carrega dados da aba Aplicaveis
						veiculosAplicaveisData = dataAplicaveis;
						if (veiculosAplicaveisData.length > 0) {
							veiculoAplicavelAtual = 0;
							renderizarPaginacaoVeiculosAplicaveis();
							renderizarVeiculoAplicavel(veiculoAplicavelAtual);
						} else {
							document.getElementById('veiculos-aplicaveis-container').innerHTML = '';
							renderizarPaginacaoVeiculosAplicaveis();
						}
						setData('dificuldade_aplicaveis', dataPrincipal.dificuldade_aplicaveis);
						setData('justificativa_aplicaveis', dataPrincipal.justificativa_aplicaveis);
						atualizarVisibilidadeDadosCardAplicaveis();

						alert("Arquivo JSON carregado com sucesso!");
					} catch (error) {
						console.error("Erro ao carregar ou processar o arquivo JSON:", error);
						alert("Ocorreu um erro ao carregar o arquivo. Verifique se o arquivo é um JSON válido e tente novamente.");
					}
				};
				reader.readAsText(file);
			}
		}

			function validarFormularioGlobal() {
				  const erros = [];

				  document.querySelectorAll('.campo-invalido, .radio-invalido').forEach(el => el.classList.remove('campo-invalido', 'radio-invalido'));

				  const checarCampo = (id, nome) => {
					const el = document.getElementById(id);
					if (!el || !el.value.trim()) {
					  erros.push(nome);
					  if (el) el.classList.add('campo-invalido');
					}
				  };

				  const checarRadio = (name, nome) => {
					const selecionado = document.querySelector(`input[name="${name}"]:checked`);
					if (!selecionado) {
					  erros.push(nome);
					  const radios = document.querySelectorAll(`input[name="${name}"]`);
					  if (radios.length > 0) {
						const container = radios[0].closest('.checkbox-inline');
						if (container) container.classList.add('radio-invalido');
					  }
					}
				  };

				  const checarAlgumCheckbox = (name, nome) => {
					const marcados = document.querySelectorAll(`input[name="${name}"]:checked`);
					if (marcados.length === 0) {
					  erros.push(nome);
					  const boxes = document.querySelectorAll(`input[name="${name}"]`);
					  if (boxes.length > 0) {
						const container = boxes[0].closest('.checkbox-inline');
						if (container) container.classList.add('radio-invalido');
					  }
					}
				  };

				  // --- 1. Principal ---
				  checarCampo('planejado_por', 'Planejado por');
				  checarCampo('clickup', 'Link do Card (ClickUp)');
				  checarCampo('veiculo', 'Veículo Referência');
				  checarCampo('iddiagramas', 'ID DIAGRAMAS');
				  checarCampo('idfusiveis', 'ID FUSÍVEIS');
				  checarCampo('pasta', 'Pasta do Veículo');
				  checarRadio('aplicacao_chassi', 'Aplicação / Chassi');

				  checarAlgumCheckbox('atmt', 'Transmissão');
				  checarAlgumCheckbox('chave', 'Comutador de Ignição');
				  checarRadio('startstop', 'Função Start/Stop');
				  checarAlgumCheckbox('ac', 'Ar-Condicionado');

				  checarRadio('adas', 'ADAS');
				  checarCampo('dificuldade', 'Dificuldade (Principal)');
				  checarCampo('justificativa', 'Justificativa (Principal)');

                  sistemasData.forEach((sistema, idx) => {
                    if (!sistema.transferencia) {
                        erros.push(`Opção de Transferência (Capítulo Principal ${idx + 1})`);
                    } else if (sistema.transferencia === 'transferencia' && !sistema.idtransf) {
                        erros.push(`ID de Transferência (Capítulo Principal ${idx + 1})`);
                    }
                  });

				  // --- 2. Aplicáveis (no array salvo) ---
				  if (veiculosAplicaveisData.length > 0) {
					salvarDadosVeiculoAplicavel(veiculoAplicavelAtual);

					veiculosAplicaveisData.forEach((veiculo, idx) => {
					  const sfx = `(Aplicável ${idx + 1})`;

					  if (!veiculo.dadosGerais.veiculo) erros.push(`Veículo Referência ${sfx}`);
					  if (!veiculo.dadosGerais.iddiagramas) erros.push(`ID DIAGRAMAS ${sfx}`);
					  if (!veiculo.dadosGerais.idfusiveis) erros.push(`ID FUSÍVEIS ${sfx}`);
                      if (!veiculo.dadosGerais.pasta) erros.push(`Pasta do Veículo ${sfx}`);
					  if (!veiculo.dadosGerais.aplicacao_chassi) erros.push(`Aplicação / Chassi ${sfx}`);

					  if (!Array.isArray(veiculo.itensSerie.atmt) || veiculo.itensSerie.atmt.length === 0) erros.push(`Transmissão ${sfx}`);
					  if (!Array.isArray(veiculo.itensSerie.chave) || veiculo.itensSerie.chave.length === 0) erros.push(`Comutador de Ignição ${sfx}`);
					  if (!veiculo.itensSerie.startstop) erros.push(`Função Start/Stop ${sfx}`);
					  if (!Array.isArray(veiculo.itensSerie.ac) || veiculo.itensSerie.ac.length === 0) erros.push(`Ar-Condicionado ${sfx}`);
					  if (!veiculo.itensSerie.adas) erros.push(`ADAS ${sfx}`);
                      
                      veiculo.sistemas.forEach((sistema, sIdx) => {
                        if (!sistema.transferencia) {
                            erros.push(`Opção de Transferência (Aplicável ${idx + 1}, Capítulo ${sIdx + 1})`);
                        } else if (sistema.transferencia === 'transferencia_outro' && !sistema.idtransf) {
                            erros.push(`ID de Transferência (Aplicável ${idx + 1}, Capítulo ${sIdx + 1})`);
                        }
                      });
					});

					checarCampo('dificuldade_aplicaveis', 'Dificuldade (Aplicáveis)');
					checarCampo('justificativa_aplicaveis', 'Justificativa (Aplicáveis)');
				  }

				  return [...new Set(erros)];
				}

		async function gerarPDF() {
			const erros = validarFormularioGlobal();
			if (erros.length > 0) {
				const lista = document.getElementById('lista-campos-faltando');
				lista.innerHTML = '';
				erros.forEach(erro => {
					const li = document.createElement('li');
					li.textContent = erro;
					lista.appendChild(li);
				});
				document.getElementById('validation-modal').style.display = 'flex';
				return; 
			}

			const { jsPDF } = window.jspdf;
			const doc = new jsPDF();
			let y = 10;
			const margin = 10;
			const lineHeight = 7;
			const pageHeight = doc.internal.pageSize.height;
			const lineSpacing = 6;

			const zip = new JSZip();
			const rootPrincipal = zip.folder('Veículo Principal');
			const rootAplicaveis = zip.folder('Veículos Aplicáveis');
			const sanitizeName = (name) => (name || '').toString().replace(/[\\\/:*?"<>|]/g, '').trim().slice(0, 120) || 'Sem título';
			const toArrayBuffer = async (dataUrl) => {
				const res = await fetch(dataUrl);
				return await res.arrayBuffer();
			};
			
			function hexToRgb(hex) {
				const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
				return result ? [parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16)] : [0, 0, 0];
			}

			function parseRgb(rgbString) {
				const match = rgbString.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
				return match ? [parseInt(match[1]), parseInt(match[2]), parseInt(match[3])] : [0, 0, 0];
			}
			
			function mapFontSize(size) {
				const sizeNum = parseInt(size);
				const sizeMap = { 1: 8, 2: 10, 3: 12, 4: 14, 5: 18 };
				return sizeMap[sizeNum] || 12;
			}
            
			function htmlToFragments(element, parentStyle = {}, listState = null) {
				let fragments = [];
				const defaultStyle = { fontStyle: 'normal', fontWeight: 'normal', textDecoration: 'none', color: [0, 0, 0], fontSize: 12, isLink: false, url: '' };
				let currentStyle = { ...defaultStyle, ...parentStyle };

				for (const node of element.childNodes) {
					if (node.nodeType === Node.TEXT_NODE) {
						if (node.textContent.trim().length > 0 || node.textContent === ' ') {
							fragments.push({ type: 'text', text: node.textContent.replace(/\n/g, ''), style: { ...currentStyle } });
						}
					} else if (node.nodeType === Node.ELEMENT_NODE) {
						let newStyle = { ...currentStyle };
						let specialFragment = null;
						let nextListState = listState;

						// Adiciona quebra de linha ANTES de elementos de bloco
						if (['div', 'p'].includes(node.tagName.toLowerCase())) {
								if (fragments.length > 0 && fragments[fragments.length - 1].type !== 'br') {
									fragments.push({ type: 'br' });
								}
						}

						switch (node.tagName.toLowerCase()) {
							case 'b': case 'strong': newStyle.fontWeight = 'bold'; break;
							case 'i': case 'em': newStyle.fontStyle = 'italic'; break;
							case 'u': newStyle.textDecoration = 'underline'; break;
							case 'font':
								if (node.color) newStyle.color = hexToRgb(node.color);
								if (node.size) newStyle.fontSize = mapFontSize(node.size);
								break;
							case 'span':
								if (node.style.color) newStyle.color = parseRgb(node.style.color);
								if (node.style.fontWeight === 'bold') newStyle.fontWeight = 'bold';
								if (node.style.fontStyle === 'italic') newStyle.fontStyle = 'italic';
								break;
							case 'br': specialFragment = { type: 'br' }; break;
							case 'img':
								specialFragment = { type: 'image', src: node.getAttribute('data-original-image'), filename: node.getAttribute('data-filename') || 'imagem.png' };
								break;
							case 'a':
								if (node.classList.contains('attachment')) {
									specialFragment = { type: 'attachment', href: node.getAttribute('href'), filename: node.getAttribute('data-filename'), text: node.textContent };
								} else {
									newStyle.isLink = true;
									newStyle.url = node.href;
									newStyle.color = [0, 0, 255];
								}
								break;
							case 'ul':
								nextListState = { type: 'ul' };
								break;
							case 'ol':
								nextListState = { type: 'ol', counter: 1 };
								break;
							case 'li':
								if (fragments.length > 0 && fragments[fragments.length - 1].type !== 'br') {
									fragments.push({ type: 'br' });
								}
								if (listState) {
								let indent = '    '; // 4 espaços para indentação
								let marker = listState.type === 'ul' ? '•  ' : `${listState.counter++}.  `;
								fragments.push({ type: 'text', text: indent + marker, style: currentStyle });
								}
								break;
						}
						if (specialFragment) fragments.push(specialFragment);

						if (node.hasChildNodes()) {
							fragments = fragments.concat(htmlToFragments(node, newStyle, nextListState));
						}

						// Adiciona quebra de linha DEPOIS de uma lista
						if (['ul', 'ol'].includes(node.tagName.toLowerCase())) {
						if (fragments.length > 0 && fragments[fragments.length - 1].type !== 'br') {
							fragments.push({ type: 'br' });
							}
						}
					}
				}
				return fragments;
			}
			
			async function renderFragments(fragments, x, startY, maxWidth, rootFolder, sistema, idx, isAplicavel, veiculo, veiculoIndex) {
				let currentX = x;
				let currentY = startY;
				const pageBottom = pageHeight - margin;
				const getCombinedFontStyle = (style) => {
					if (style.fontWeight === 'bold' && style.fontStyle === 'italic') return 'bolditalic';
					if (style.fontWeight === 'bold') return 'bold';
					if (style.fontStyle === 'italic') return 'italic';
					return 'normal';
				};
				const applyStyle = (style) => {
					doc.setFontSize(style.fontSize);
					doc.setFont('helvetica', getCombinedFontStyle(style));
					doc.setTextColor(style.color[0], style.color[1], style.color[2]);
				};
				for (const fragment of fragments) {
					if (currentY > pageBottom) { doc.addPage(); currentY = margin; currentX = x; }
					if (fragment.type === 'text') {
						applyStyle(fragment.style);
						const words = fragment.text.split(/(\s+)/).filter(w => w.length > 0);
						for (const word of words) {
							const isSpace = word.trim().length === 0;
							const wordWidth = doc.getTextWidth(word);
							if (currentX + wordWidth > maxWidth && !isSpace) {
								currentY += lineHeight;
								currentX = x;
								if (currentY > pageBottom) { doc.addPage(); currentY = margin; }
							}
							if (!isSpace) {
								if (fragment.style.isLink) doc.textWithLink(word, currentX, currentY, { url: fragment.style.url });
								else doc.text(word, currentX, currentY);
								if (fragment.style.textDecoration === 'underline') {
									doc.setDrawColor(fragment.style.color[0], fragment.style.color[1], fragment.style.color[2]);
									doc.line(currentX, currentY + 1, currentX + wordWidth, currentY + 1);
									doc.setDrawColor(0,0,0);
								}
							}
							currentX += wordWidth;
						}
					} else if (fragment.type === 'br') {
						currentY += lineHeight;
						currentX = x;
					} else if (fragment.type === 'image' && fragment.src) {
						const imgProps = doc.getImageProperties(fragment.src);
						const maxImgWidth = doc.internal.pageSize.width - margin * 2;
						const maxImgHeight = doc.internal.pageSize.height - margin * 2;

						let finalWidth = imgProps.width;
						let finalHeight = imgProps.height;

						// Redimensiona se a largura original for maior que a largura da página
						if (finalWidth > maxImgWidth) {
							finalHeight = (imgProps.height * maxImgWidth) / imgProps.width;
							finalWidth = maxImgWidth;
						}

						// Redimensiona novamente se a altura (potencialmente já reduzida) for maior que a altura da página
						if (finalHeight > maxImgHeight) {
							finalWidth = (finalWidth * maxImgHeight) / finalHeight;
							finalHeight = maxImgHeight;
						}

						if (currentY + finalHeight > pageBottom) {
							doc.addPage();
							currentY = margin;
						}

						doc.addImage(fragment.src, 'JPEG', x, currentY, finalWidth, finalHeight);
						currentY += finalHeight;

						currentX = x;
						const capTitulo = sanitizeName(sistema ? sistema.sistema : `Geral`);
						const chapterFolderName = `Capítulo ${idx + 1} - ${capTitulo}`;
						let chapterFolder = rootFolder;
						if(isAplicavel) {
							const veicLabelRaw = extrairTooltipVeiculo(veiculo.dadosGerais.veiculo) || `#${veiculoIndex + 1}`;
							const veicLabel = `Veículo ${sanitizeName(veicLabelRaw)}`;
							const vehicleFolder = rootFolder.folder(veicLabel);
							chapterFolder = vehicleFolder.folder(chapterFolderName);
						} else {
							chapterFolder = rootFolder.folder(chapterFolderName);
						}
						const imgsFolder = chapterFolder.folder('Imagens');
						const ab = await toArrayBuffer(fragment.src);
						imgsFolder.file(sanitizeName(fragment.filename), ab);
					} else if (fragment.type === 'attachment') {
						doc.setTextColor(0, 0, 255);
						doc.setFont('helvetica', 'normal');
						doc.textWithLink(`Anexo: ${fragment.text}`, currentX, currentY, { url: '#' });
						doc.setTextColor(0,0,0);
						currentY += lineHeight;
						currentX = x;
						const capTitulo = sanitizeName(sistema ? sistema.sistema : `Geral`);
						const chapterFolderName = `Capítulo ${idx + 1} - ${capTitulo}`;
						let chapterFolder = rootFolder;
						if(isAplicavel) {
							const veicLabelRaw = extrairTooltipVeiculo(veiculo.dadosGerais.veiculo) || `#${veiculoIndex + 1}`;
							const veicLabel = `Veículo ${sanitizeName(veicLabelRaw)}`;
							const vehicleFolder = rootFolder.folder(veicLabel);
							chapterFolder = vehicleFolder.folder(chapterFolderName);
						} else {
							chapterFolder = rootFolder.folder(chapterFolderName);
						}
						const anexosFolder = chapterFolder.folder('Anexos');
						const ab = await toArrayBuffer(fragment.href);
						anexosFolder.file(sanitizeName(fragment.filename), ab);
					}
				}
				return currentY;
			}
			
			const addText = (text, size, style = 'normal', indent = 0) => {
				if (!text) return;
				const maxWidth = doc.internal.pageSize.width - (margin * 2) - indent;
				doc.setFontSize(size);
				doc.setFont('helvetica', style);
				const paragraphs = String(text).split('\n');
				for (const paragraph of paragraphs) {
					const lines = doc.splitTextToSize(paragraph, maxWidth);
					for (const line of lines) {
						if (y + lineHeight > pageHeight - margin) { doc.addPage(); y = margin; }
						doc.text(line, margin + indent, y);
						y += lineHeight;
					}
				}
			};

			const addLabeledValue = (label, value, indent = 0, size = 12) => {
				if (value === undefined || value === null || String(value).trim() === '') return;
				const fullLabel = `- ${label}: `;
				const fullValue = String(value);
				const availableWidth = doc.internal.pageSize.width - margin * 2;
				const x = margin + indent;
				doc.setFontSize(size);
				doc.setFont('helvetica', 'bold');
				const labelWidth = doc.getTextWidth(fullLabel);
				doc.setFont('helvetica', 'normal');
				const valueWidth = availableWidth - x - labelWidth;
				const paragraphs = fullValue.split('\n');
				let isFirstLineOfValue = true;
				for (const paragraph of paragraphs) {
					const lines = doc.splitTextToSize(paragraph, valueWidth);
					for (const line of lines) {
						 if (y + lineHeight > pageHeight - margin) { doc.addPage(); y = margin; }
						if (isFirstLineOfValue) {
							doc.setFont('helvetica', 'bold');
							doc.text(fullLabel, x, y);
							doc.setFont('helvetica', 'normal');
							doc.text(line, x + labelWidth, y);
							isFirstLineOfValue = false;
						} else {
							doc.text(line, x + labelWidth, y);
						}
						y += lineHeight;
					}
				}
			};

			async function addRichContent(htmlString, startY, indent, rootFolder, sistema, idx, isAplicavel, veiculo, veiculoIndex) {
				if (!htmlString || !htmlString.trim()) {
					addText('Nenhum conteúdo informado.', 12, 'italic', indent);
					return y + lineHeight;
				}
				const tempDiv = document.createElement('div');
				tempDiv.innerHTML = htmlString;
				const fragments = htmlToFragments(tempDiv);
				const finalY = await renderFragments(fragments, margin + indent, startY, doc.internal.pageSize.width - (margin * 2) - indent, rootFolder, sistema, idx, isAplicavel, veiculo, veiculoIndex);
				doc.setTextColor(0, 0, 0);
				return finalY;
			}
			
			const formatArray = (arr) => Array.isArray(arr) && arr.length ? arr.join(', ') : '';
			const mapStartStop = (v) => ({ sim_serie: 'Sim (De Série)', sim_opcional: 'Sim (Opcional)', nao: 'Não' }[v] || '');

			const addCenteredText = (text, size, style = 'normal', color = [0, 0, 0]) => {
				if (y > pageHeight - margin) { doc.addPage(); y = margin; }
				doc.setFontSize(size);
				doc.setFont('helvetica', style);
				doc.setTextColor(color[0], color[1], color[2]);
				const textWidth = doc.getTextWidth(text);
				const centerX = (doc.internal.pageSize.width - textWidth) / 2;
				doc.text(text, centerX, y);
				y += lineHeight;
				doc.setTextColor(0, 0, 0);
			};
			
			
			const addColoredText = (text, size, style = 'normal', indent = 0, color = [0, 0, 0]) => {
				if (y > pageHeight - margin) { doc.addPage(); y = margin; }
				doc.setFontSize(size);
				doc.setFont('helvetica', style);
				doc.setTextColor(color[0], color[1], color[2]);
				const textWidth = doc.getTextWidth(text);
				const centerX = (doc.internal.pageSize.width - textWidth) / 2;
				doc.text(text, centerX, y);
				y += lineHeight;
				doc.setTextColor(0, 0, 0);
			};

			const addHighlightedText = (text, size, style = 'bold', indent = 0, r = 212, g = 255, b = 214) => {
				if (y > pageHeight - margin) { doc.addPage(); y = margin; }
				doc.setFontSize(size);
				doc.setFont('helvetica', style);
				const x = margin + indent;
				const textWidth = doc.getTextWidth(text);
				const rectX = x - 2;
				const rectY = y - lineHeight + 1.5;
				const rectW = textWidth + 4;
				const rectH = lineHeight;
				doc.setFillColor(r, g, b);
				doc.rect(rectX, rectY, rectW, rectH, 'F');
				doc.setTextColor(0, 0, 0);
				doc.text(text, x, y);
				y += lineHeight;
			};
			
			const addSeparatorLine = () => {
				if (y > pageHeight - margin) { doc.addPage(); y = margin; }
				doc.setDrawColor(128, 128, 128);
				doc.setLineWidth(0.5);
				doc.line(margin, y, doc.internal.pageSize.width - margin, y);
				y += lineHeight;
			};

			const data = coletarDadosFormulario();
			const dataPrincipal = data.principal;
			const dataAplicaveis = data.aplicaveis;
			const titleColor = [68, 114, 196];

			// --- VEÍCULO PRINCIPAL ---
			addCenteredText("PLANEJAMENTO - VEÍCULO PRINCIPAL", 20, 'bold');
			addColoredText(dataPrincipal.clickup, 14, 'italic', 0, titleColor);
			
			y += lineHeight * 2;
			addColoredText("INFORMAÇÕES GERAIS", 18, 'bold', 0, titleColor);
			y += lineSpacing;
			addLabeledValue('PLANEJADO POR', dataPrincipal.planejado_por);
			addText('- VEÍCULO REFERÊNCIA:', 12, "bold", 0);
			addText(dataPrincipal.veiculo, 10, "italic", 4);
			y += lineHeight;
			addLabeledValue('ID DIAGRAMAS', dataPrincipal.iddiagramas);
			addLabeledValue('ID FUSÍVEIS', dataPrincipal.idfusiveis);
			
			y += lineHeight;
			
			addText('- PASTA DO VEÍCULO:', 12, "bold", 0);
			addText(dataPrincipal.pasta, 8, "italic", 4);
					
			y += lineHeight;
			
			addText('- IMPORTANTE PARA O DESENVOLVIMENTO:', 12, 'bold', 0);
			y = await addRichContent(dataPrincipal.comentarios, y, 4, rootPrincipal, null, -1);
			y += lineSpacing;
			
			addLabeledValue('APLICAÇÃO / CHASSI', dataPrincipal.aplicacao_chassi === 'mesma' ? 'Mesma aplicação' : (dataPrincipal.aplicacao_chassi === 'ajustar' ? 'Ajustar aplicação' : 'N/A'));
			if (dataPrincipal.aplicacao_chassi_texto) {
				addText(dataPrincipal.aplicacao_chassi_texto, 12, 'normal', 4);
			}
			y += lineSpacing;
			addText('- PEDIDOS DE ILUSTRAÇÃO / TRATAMENTO DE IMAGEM:', 12, 'bold', 0);
			addText(dataPrincipal.ilustracao_texto || 'Nenhum pedido.', 10, 'italic', 4);
			
			y += lineHeight;
			
			addLabeledValue('PESQUISA', dataPrincipal.pesquisa === 'sim' ? 'Sim' : 'Não');
			if (dataPrincipal.pesquisa === 'sim' && dataPrincipal.pesquisa_texto) {
				addText(dataPrincipal.pesquisa_texto, 8, 'italic', 4);
			}
			y += lineHeight;

			addText('- ITENS DE SÉRIE / OPCIONAIS:', 12, "bold", 0);
            addLabeledValue('Tipo de Chave', formatArray(dataPrincipal.chave));
            addLabeledValue('Função Start/Stop', mapStartStop(dataPrincipal.startstop));
            addLabeledValue('Ar-condicionado', formatArray(dataPrincipal.ac));
			addLabeledValue('Transmissão', formatArray(dataPrincipal.atmt));
            addLabeledValue('Tração', formatArray(dataPrincipal.tracao));
            //addLabeledValue('ADAS', (dataPrincipal.adas === 'sim_serie' ? 'Sim (De Série)' : (dataPrincipal.adas === 'sim_opcional' ? `Sim (Opcional)\n${dataPrincipal.adas_texto}` : 'Não')));
            //addLabeledValue('Extras', dataPrincipal.extras);
			let adasText = 'Não';
			if (dataPrincipal.adas === 'sim_serie') adasText = 'Sim (De Série)';
			if (dataPrincipal.adas === 'sim_opcional') adasText = 'Sim (Opcional)';
            addLabeledValue('ADAS', adasText, 0);
			if ((dataPrincipal.adas === 'sim_serie' || dataPrincipal.adas === 'sim_opcional') && dataPrincipal.adas_texto) {
			addText(dataPrincipal.adas_texto, 12, 'normal', 4);
			}
            addText('- Extras:', 12, "bold", 0);
			addText(dataPrincipal.extras, 12, "normal", 4);
			
			y += lineSpacing;
			y += 6;
			
			addColoredText("SISTEMAS", 18, 'bold', 0, titleColor);
			y += lineSpacing;
			
			if (dataPrincipal.sistemas && dataPrincipal.sistemas.length > 0) {
				for (const [idx, sistema] of dataPrincipal.sistemas.entries()) {
					if (y > pageHeight - margin * 4) { doc.addPage(); y = margin; }
					y += lineSpacing / 2;
					
					addHighlightedText(`CAPÍTULO: ${sistema.sistema || ''}`, 14, 'bold', 0, 212, 255, 214);
					let linhaTransferencia = '';
					if (sistema.transferencia === 'transferencia') linhaTransferencia = `- Transferência - ID: ${sistema.idtransf || ''}`;
					else if (sistema.transferencia === 'zero') linhaTransferencia = `Fazer do Zero`;
					else if (sistema.transferencia === 'modificar') linhaTransferencia = `- Modificar Publicado`;
					if (linhaTransferencia) addText(linhaTransferencia, 12, "bold", 0);
					
					addLabeledValue('Nº páginas prevista', `${sistema.transferencia === 'modificar' ? '0' : (sistema.paginasprev || '')}`);
					//addText(`- Nº páginas prevista: ${sistema.transferencia === 'modificar' ? '0' : (sistema.paginasprev || '')}`, 12, "normal", 4);
					const isCaixasForm = sistema.sistema === "Fusíveis e Relés";
					const isPaginasForm = sistema.sistema === "Alimentação Positiva" || sistema.sistema === "Conectores de Peito";

					if (!isCaixasForm && !isPaginasForm) {
						addLabeledValue('Módulo principal', `${sistema.modulo || ''}`);
						addLabeledValue('Nome no material', `${sistema.nomematerial || ''}`);
						addText(`- Códigos de Conectores:`, 12, "bold", 0);
						addText(`${sistema.codconectores || ''}`, 12, 'normal', 4)
						addText(`- Código de Peça / Link:`, 12, "bold", 0);
						y = await addRichContent(sistema.codmodulo, y, 4, rootPrincipal, sistema, idx);
						y += 6;
					}
					y += 6;

					addText('DESENVOLVIMENTO:', 14, "bold", 0);
					y += lineSpacing / 2;

					if (isCaixasForm) {
						if (sistema.caixas && sistema.caixas.length > 0) {
							for (const [caixaIdx, caixa] of sistema.caixas.entries()) {
								addText(`- Caixa ${caixaIdx + 1}: ${caixa.nome || 'Sem nome'}`, 12, "bold", 0);
								y = await addRichContent(caixa.descricoes, y, 4, rootPrincipal, sistema, idx);
								y += lineHeight * 2;
							}
						} else { addText('Nenhuma caixa adicionada.', 12, 'italic', 4); y += lineHeight; }
					} else if (isPaginasForm) {
						if (sistema.paginas && sistema.paginas.length > 0) {
							for (const [paginaIdx, pagina] of sistema.paginas.entries()) {
								addText(`- Página ${paginaIdx + 1}:`, 12, "bold", 0);
								y = await addRichContent(pagina.conteudo, y, 4, rootPrincipal, sistema, idx);
								y += lineHeight * 2;
							}
						} else { addText('Nenhuma página adicionada.', 12, 'italic', 4); y+= lineHeight; }
					} else {
                        addText(`- Página de Localização:`, 12, "bold", 0);
						y = await addRichContent(sistema.pagloc, y, 4, rootPrincipal, sistema, idx);
						y += lineHeight * 2;
						addText(`- Página de Conectores:`, 12, "bold", 0);
						y = await addRichContent(sistema.pagcon, y, 4, rootPrincipal, sistema, idx);
						y += lineHeight * 2;
						addText(`- Página de Diagramas:`, 12, "bold", 0);
						y = await addRichContent(sistema.pagdiag, y, 4, rootPrincipal, sistema, idx);
						y += lineHeight * 2;
					}
				}
			} else { addText("Nenhum sistema adicionado.", 12, "italic", 4); y += lineHeight; }
			y += lineHeight;
			addSeparatorLine();
			y += lineHeight;

			addColoredText("DADOS DO CARD", 18, 'bold', 0, titleColor);
			y += lineHeight;
			addLabeledValue('Dificuldade', dataPrincipal.dificuldade);
			addLabeledValue('Justificativa', dataPrincipal.justificativa);
			let somaTotal = 0, somaTransferidas = 0, somaCriadas = 0;
			if (dataPrincipal.sistemas) dataPrincipal.sistemas.forEach(s => {
				const paginas = parseInt(s.paginasprev) || 0;
				somaTotal += paginas;
				if (s.transferencia === 'transferencia' || s.transferencia === 'modificar') somaTransferidas += paginas;
				else somaCriadas += paginas;
			});
			y += lineSpacing;
			addText(`PPP:`, 14, "bold", 0);
			addText(`- Total: ${somaTotal}\n- Páginas Criadas do zero: ${somaCriadas}\n- Páginas Transferidas: ${somaTransferidas}`, 12, "normal", 0);

			//VEÍCULOS APLICÁVEIS

			if (dataAplicaveis && dataAplicaveis.length > 0) {
				doc.addPage();
				y = margin;
				addCenteredText("PLANEJAMENTO - VEÍCULOS APLICÁVEIS", 20, 'bold');
				for (const [index, veiculo] of dataAplicaveis.entries()) {
					if (y > pageHeight - margin * 4) { doc.addPage(); y = margin; }
					y += lineSpacing;
					y += lineHeight;
					
					addColoredText(`VEÍCULO APLICÁVEL #${index + 1}`, 18, "bold", 0, titleColor);
					y += lineSpacing;
					
					addText('- VEÍCULO REFERÊNCIA:', 12, "bold", 0);
					addText(veiculo.dadosGerais.veiculo, 10, "italic", 4);
					
					y += lineSpacing;
					
					addLabeledValue('ID DIAGRAMAS', veiculo.dadosGerais.iddiagramas);
					addLabeledValue('ID FUSÍVEIS', veiculo.dadosGerais.idfusiveis);
					
					y += lineSpacing;
					
					addText('- PASTA DO VEÍCULO:', 12, "bold");
                    addText(veiculo.dadosGerais.pasta, 8, 'italic', 0);
					
					y += lineSpacing;
					
					addText('- IMPORTANTE PARA O DESENVOLVIMENTO:', 12, 'bold');
					y = await addRichContent(veiculo.dadosGerais.comentarios, y, 4, rootAplicaveis, null, -1, true, veiculo, index);
					
					y += lineHeight;
					y += lineHeight / 2;
					
					addLabeledValue('APLICAÇÃO / CHASSI', veiculo.dadosGerais.aplicacao_chassi === 'mesma' ? 'Mesma aplicação' : (veiculo.dadosGerais.aplicacao_chassi === 'ajustar' ? 'Ajustar aplicação' : 'N/A'));
					if (veiculo.dadosGerais.aplicacao_chassi_texto) {
						addText(veiculo.dadosGerais.aplicacao_chassi_texto, 12, 'normal', 4);
					}
					y += lineHeight;

					addText('- PEDIDOS DE ILUSTRAÇÃO / TRATAMENTO DE IMAGEM:', 12, 'bold');
					addText(veiculo.dadosGerais.ilustracao_texto || 'Nenhum pedido.', 12, 'italic', 4);
					
					y += lineHeight;
					
					addLabeledValue('PESQUISA', veiculo.dadosGerais.pesquisa === 'sim' ? 'Sim' : 'Não');
					if (veiculo.dadosGerais.pesquisa === 'sim' && veiculo.dadosGerais.pesquisa_texto) {
						addText(veiculo.dadosGerais.pesquisa_texto, 10, "italic", 4);
					}
					y += lineHeight;
					                    
					addText('- ITENS DE SÉRIE/OPCIONAIS:', 12, "bold");
                    addLabeledValue('Tipo de Chave', formatArray(veiculo.itensSerie.chave));
                    addLabeledValue('Função Start/Stop', mapStartStop(veiculo.itensSerie.startstop));
                    addLabeledValue('Ar-condicionado', formatArray(veiculo.itensSerie.ac));
					addLabeledValue('Transmissão', formatArray(veiculo.itensSerie.atmt));
                    addLabeledValue('Tração', formatArray(veiculo.itensSerie.tracao));
					let adasTextAplicavel = 'Não';
					addLabeledValue('ADAS', adasTextAplicavel, 0);
					if ((veiculo.itensSerie.adas === 'sim_serie' || veiculo.itensSerie.adas === 'sim_opcional') && veiculo.itensSerie.adas_texto) {
					  addText(veiculo.itensSerie.adas_texto, 12, 'normal', 4);
					}
					addText('- Extras:', 12, "bold", 0);
					addText(veiculo.itensSerie.extras, 12, "normal", 4);
					//addLabeledValue('ADAS', (veiculo.itensSerie.adas === 'sim_serie' ? 'Sim (De Série)' : (veiculo.itensSerie.adas === 'sim_opcional' ? `Sim (Opcional)\n${veiculo.itensSerie.adas_texto}` : 'Não')));
                    //addLabeledValue('Extras', veiculo.itensSerie.extras);
					y += lineHeight;
					y += 6;

					addColoredText("SISTEMAS", 18, 'bold', 0, titleColor);
					if (veiculo.sistemas && veiculo.sistemas.length > 0) {
						for (const [idx, sistema] of veiculo.sistemas.entries()) {
							if (y > pageHeight - margin * 4) { doc.addPage(); y = margin; }
							y += lineHeight;
							
							addHighlightedText(`CAPÍTULO: ${sistema.sistema || ''}`, 14, 'bold', 0, 250, 231, 67);
							if (sistema.transferencia === 'transferencia_principal') {
								const idPrincipal = (sistema.sistema === 'Fusíveis e Relés')
									? dataPrincipal.idfusiveis
									: dataPrincipal.iddiagramas;
								addLabeledValue('Transferência (do Principal) - ID', ` ${idPrincipal || 'N/A'}`);
							} else if (sistema.transferencia === 'transferencia_outro') {
								addLabeledValue('Transferência (Outro) - ID', ` ${sistema.idtransf || 'N/A'}`);
							} else if (sistema.transferencia === 'modificar') {
								addText(`- Modificar Publicado`, 12, "normal", 0);
							}
							addLabeledValue('Nº páginas prevista', sistema.transferencia === 'modificar' ? '0' : sistema.paginasprev);
							
							const isCaixasForm = sistema.sistema === "Fusíveis e Relés";
							const isPaginasForm = sistema.sistema === "Alimentação Positiva" || sistema.sistema === "Conectores de Peito";
		
							if (!isCaixasForm && !isPaginasForm) {
								addLabeledValue('Módulo principal', sistema.modulo);
								addLabeledValue('Nome no material', sistema.nomematerial);
								addText(`- Códigos de Conectores:`, 12, "bold", 0);
						        addText(sistema.codconectores, 12, 'normal', 4)
								addText(`- Código de Peça / Link:`, 12, "bold", 0);
								y = await addRichContent(sistema.codmodulo, y, 4, rootAplicaveis, sistema, idx, true, veiculo, index);
                                y += 6;
							}
							y += 6;
							
							addText(`DESENVOLVIMENTO:`, 14, "bold", 0);
							y += lineSpacing / 2;
							
							if (isCaixasForm) {
								if (sistema.caixas && sistema.caixas.length > 0) {
									for (const [caixaIdx, caixa] of sistema.caixas.entries()) {
										y += lineSpacing / 2;
										addText(`- Caixa ${caixaIdx + 1}: ${caixa.nome || 'Sem nome'}`, 12, "bold", 0);
										y = await addRichContent(caixa.descricoes, y, 4, rootAplicaveis, sistema, idx, true, veiculo, index);
										y += lineHeight;
									}
								} else { addText('Nenhuma caixa adicionada.', 12, 'italic', 4); y += lineHeight;}
							} else if (isPaginasForm) {
								if (sistema.paginas && sistema.paginas.length > 0) {
									for (const [paginaIdx, pagina] of sistema.paginas.entries()) {
										y += lineSpacing / 2;
										addText(`- Página ${paginaIdx + 1}:`, 12, "bold", 0);
										y = await addRichContent(pagina.conteudo, y, 4, rootAplicaveis, sistema, idx, true, veiculo, index);
										y += lineHeight;
									}
								} else { addText('Nenhuma página adicionada.', 12, 'italic', 4); y+= lineHeight; }
							} else {
								addText(`- Página de Localização:`, 12, "bold", 0);
								y = await addRichContent(sistema.pagloc, y, 4, rootAplicaveis, sistema, idx, true, veiculo, index);
								y += 12;
								addText(`- Página de Conectores:`, 12, "bold", 0);
								y = await addRichContent(sistema.pagcon, y, 4, rootAplicaveis, sistema, idx, true, veiculo, index);
								y += 12;
								addText(`- Página de Diagramas:`, 12, "bold", 0);
								y = await addRichContent(sistema.pagdiag, y, 4, rootAplicaveis, sistema, idx, true, veiculo, index);
								y += 12;
							}
						}
					} else {
						addText("Nenhum sistema adicionado.", 12, "normal", 4);
					}
					y += lineHeight;
					addSeparatorLine();
				}

				y += lineHeight;
				addColoredText("DADOS DO CARD (APLICÁVEIS)", 18, 'bold', 0, titleColor);
				y += lineHeight;
				addLabeledValue('Dificuldade', data.principal.dificuldade_aplicaveis);
				addLabeledValue('Justificativa', data.principal.justificativa_aplicaveis);
				let somaTotalAplicaveis = 0, somaTransferidasAplicaveis = 0, somaCriadasAplicaveis = 0;
				dataAplicaveis.forEach(v => {
					if (v.sistemas && v.sistemas.length > 0) {
						v.sistemas.forEach(s => {
							const paginas = parseInt(s.paginasprev) || 0;
							somaTotalAplicaveis += paginas;
							if (s.transferencia === 'transferencia_principal' || s.transferencia === 'transferencia_outro' || s.transferencia === 'modificar') {
								somaTransferidasAplicaveis += paginas;
							}
						});
					}
				});
				y += lineHeight;
				addText(`PPA:`, 14, "bold");
				addText(`- Total: ${somaTotalAplicaveis}\n- Páginas Transferidas: ${somaTransferidasAplicaveis}`, 12, "normal", 4);
			}
			
			let nomeBase = "planejamento";
			if (dataPrincipal.veiculo && dataPrincipal.veiculo.includes('>')) {
				const partes = dataPrincipal.veiculo.split('>');
				if (partes.length >= 5) {
					const ano = partes[1].trim();
					const modelo = partes[3].trim();
					const motor = partes[4].trim();
					nomeBase = `Planejamento - ${ano} ${modelo} ${motor}`;
				}
			} else if (dataPrincipal.veiculo) {
				nomeBase = `Planejamento - ${dataPrincipal.veiculo}`;
			}
			
			const nomeArquivoPDF = `${nomeBase}.pdf`;
			doc.save(nomeArquivoPDF);

			const zipContent = await zip.generateAsync({ type: 'blob' });
			if (zipContent && zipContent.size > 22) { 
				const nomeZip = `${nomeBase}.zip`;
				const a = document.createElement('a');
				const url = URL.createObjectURL(zipContent);
				a.href = url;
				a.download = nomeZip;
				document.body.appendChild(a);
				a.click();
				document.body.removeChild(a);
				URL.revokeObjectURL(url);
			}
            
            salvarComoJSON();
		}
		
		
		
		document.addEventListener('DOMContentLoaded', (event) => {
            alternarAbas('principal');
            setupDragAndDrop('comentarios');
            setupEditableContent('comentarios');
        });

        window.addEventListener('beforeunload', function (e) {
            const confirmationMessage = 'AVISO: Todas as alterações não salvas serão perdidas';
            e.returnValue = confirmationMessage;
            return confirmationMessage;
        });
    </script>
</body>
</html>
